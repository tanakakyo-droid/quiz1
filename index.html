<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è‹±æ¤œæº–ä¸€ç´šå˜èªã‚¯ã‚¤ã‚º</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/wanakana/wanakana.min.js"></script>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">

  <style>
    :root {
      --duo-green: #58cc02;
      --duo-green-dark: #58a700;
      --duo-blue: #1cb0f6;
      --duo-blue-dark: #1899d6;
      --duo-red: #ea2b2b;
      --duo-yellow-light: rgba(254, 219, 0, 0.1);
      --duo-green-light: rgba(88, 204, 2, 0.15);
      --duo-blue-light: rgba(28, 176, 246, 0.1);
      --duo-gray-light: #f7f7f7;
      --duo-gray-border: #e5e5e5;
      --white: #ffffff;
      --dark-text: #4c4c4c;
    }

    body {
      font-family: 'Nunito', sans-serif;
      text-align: center;
      margin: 0;
      padding: 0;  
      color: var(--dark-text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      overflow-x: hidden;
      
      background-color: var(--duo-gray-light);
      background-image: 
        radial-gradient(circle 50vmax at 10% 20%, var(--duo-green-light), transparent 50%),
        radial-gradient(circle 40vmax at 90% 85%, var(--duo-blue-light), transparent 50%),
        radial-gradient(circle 35vmax at 50% 50%, var(--duo-yellow-light), transparent 45%);
      background-repeat: no-repeat;
      background-attachment: fixed;
    }
    header {
      background: #8DECB4;
      padding: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 2px solid var(--duo-gray-border);
      position: relative;  
      z-index: 10;
      width: 100%;
      box-sizing: border-box;
    }
    #title {
      flex-grow: 1;
      text-align: center;
      font-size: 32px;
      font-weight: 900;
      font-style: italic;
      color: var(--dark-text);
      text-shadow: none;
    }

    #start-screen, .quiz-container {
      max-width: 800px;
      margin: 40px auto;
      padding: 40px;
      background: var(--white);
      border-radius: 16px;
      border: 2px solid var(--duo-gray-border);
      opacity: 0;
    }
    
    .animate-in {
        animation: fadeInUp 0.5s 0.1s ease-out forwards;
    }
    .feedback-animate {
        animation: popIn 0.4s ease-out forwards;
    }

    #start-screen h1 {
      font-size: 32px;
      font-weight: 900;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #start-screen p {
      font-size: 18px;
      color: var(--dark-text);
      margin-bottom: 20px;
    }
    #new-user-input, #user-select, #passcode-input {
      padding: 12px 15px;
      font-size: 18px;
      font-family: 'Nunito', sans-serif;
      font-weight: 700;
      width: 300px;
      border: 2px solid var(--duo-gray-border);
      border-radius: 12px;
      display: block;
      margin: 0 auto 20px;
      transition: all 0.2s ease;
    }
    #new-user-input:focus, #user-select:focus, #passcode-input:focus {
      outline: none;
      border-color: var(--duo-blue);
    }
    
    .quiz-container {
      width: 100%;
      min-height: 550px;
      box-sizing: border-box;
    }
    .input-field {
      margin: 10px;
      padding: 10px 15px;
      font-size: 20px;
      font-weight: 700;
      width: 250px;
      border: 2px solid var(--duo-gray-border);
      border-radius: 12px;
      transition: all 0.2s ease;
    }
    .input-field:focus {
      outline: none;
      border-color: var(--duo-blue);
    }
    .input-field:disabled {
        background-color: #f2f2f2;
        color: #999;
    }
    
    .button {
      position: relative;
      margin: 10px 5px;
      padding: 12px 24px;
      font-size: 18px;
      font-weight: 900;
      text-transform: uppercase;
      cursor: pointer;
      border: none;
      border-radius: 16px;
      color: white;
      transition: top 0.1s ease, background 0.2s ease;
    }
    .button.btn-green {
      background: var(--duo-green);
      border-bottom: 4px solid var(--duo-green-dark);
    }
    .button.btn-blue {
        background: var(--duo-blue);
        border-bottom: 4px solid var(--duo-blue-dark);
    }
    .button:active {
        top: 2px;
        border-bottom-width: 2px;
    }
    .button:disabled {
        background: #ccc;
        border-bottom: 4px solid #999;
        cursor: not-allowed;
        top: 0;
    }
    .button:disabled:active {
        top: 0;
        border-bottom-width: 4px;
    }

    #header-buttons-container {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
    }
    #header-buttons-container div { margin-bottom: 5px; }
    #header-buttons-container div:last-child { margin-bottom: 0; }

    #toggleHistoryBtn { display: none; }

    .circle-button {
      width: 36px;
      height: 36px;
      padding: 0;
      border-radius: 50%;
      margin-left: 8px;
      font-size: 16px;
      border-bottom: 2px solid var(--duo-green-dark);
    }
     .circle-button:active {
        top: 1px;
        border-bottom-width: 1px;
    }
    .hidden { display: none; }
    #question { 
      font-size: 28px; 
      font-weight: 900; 
      margin-bottom: 15px;
    }
    #question .jp-translation {
      font-size: 18px;
      color: var(--dark-text);
      margin-top: 8px;
      font-weight: 400;
    }
    #translation { font-size: 18px; margin-top: 20px; line-height: 1.6; }
    #input-wrapper {
      position: relative;
      min-height: 60px;
      margin: 20px 0;
    }
    #feedback {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(160px, -50%);
      width: 200px;
      text-align: left;
      font-size: 24px;
      font-weight: 900;
      opacity: 0;
    }
    #feedback.correct { color: var(--duo-green); }
    #feedback.incorrect { color: var(--duo-red); }

    .progress-bar {
      height: 20px;
      background-color: var(--duo-gray-border);
      border-radius: 10px;
      margin-top: 20px;
      overflow: hidden;
      padding: 4px;
    }
    .progress {
      height: 100%;
      width: 0%;
      background: var(--duo-green);
      border-radius: 8px;
      transition: width 0.4s ease-in-out;
      box-shadow: inset 0 2px 0 rgba(255,255,255,0.2);
    }

    #history-container {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      max-height: 250px;
      overflow-y: auto;
      background-color: var(--white);
      border-top: 2px solid var(--duo-gray-border);
      padding: 10px;
      box-sizing: border-box;
      text-align: left;
      transform: translateY(100%);  
      transition: transform 0.3s ease-in-out;  
      z-index: 100;
    }
    #history-container.show { transform: translateY(0); }
    #history-container h2 {
      margin-top: 0;
      margin-bottom: 10px;
      text-align: center;
      display: flex;
      justify-content: center;
      align-items: center;
      font-weight: 900;
    }
    #history-list { list-style: none; padding: 0; margin: 0; }
    #history-list li {
      background-color: var(--white);
      padding: 10px;
      border-bottom: 1px solid var(--duo-gray-border);
      font-size: 14px;
      cursor: pointer;  
      transition: background-color 0.2s;
    }
    #history-list li:hover { background-color: var(--duo-gray-light); }

    #clearHistoryBtn {
      font-size: 12px;
      padding: 4px 8px;
      background-color: var(--duo-red);
      border: none;
      color: white;
      border-radius: 5px;
      cursor: pointer;
      margin-left: 15px;
    }
    #historySearchInput {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
      box-sizing: border-box;
    }
    #closeHistoryBtn {
      position: absolute;
      top: 5px;
      right: 10px;
      font-size: 28px;
      font-weight: bold;
      color: #888;
      background: none;
      border: none;
      cursor: pointer;
      padding: 0;
      line-height: 1;
    }
    #closeHistoryBtn:hover { color: #000; }
    
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes popIn {
      0% { transform: translate(160px, -50%) scale(0.8); opacity: 0; }
      80% { transform: translate(160px, -50%) scale(1.1); opacity: 1; }
      100% { transform: translate(160px, -50%) scale(1); opacity: 1; }
    }

    @media (max-width: 768px) {
      body { padding-bottom: 10px; }
      header { flex-direction: column; padding: 10px 5px; }
      #title {
        font-size: 22px;
        margin-bottom: 10px;
      }
      #header-buttons-container { align-items: center; }
      .button { padding: 10px 12px; font-size: 14px; }
      #start-screen, .quiz-container { width: 95%; margin: 15px auto; padding: 20px; min-height: 0; }
      #start-screen h1 { font-size: 24px; }
      #new-user-input, #user-select, #passcode-input { width: 90%; box-sizing: border-box; font-size: 18px; }
      #question { font-size: 22px; }
      #feedback { position: static; transform: none; text-align: center; width: 100%; margin-top: 10px; font-size: 20px; }
      @keyframes popIn {
          0% { transform: scale(0.8); opacity: 0; }
          80% { transform: scale(1.1); opacity: 1; }
          100% { transform: scale(1); opacity: 1; }
      }
      #input-wrapper { min-height: 0; display: flex; flex-direction: column; align-items: center; }
      #history-container { max-height: 40%; }
    }
  </style>
</head>
<body>
  <header class="hidden">
    <div id="title">Eiken Pre-1 Vocabulary Quiz</div>
    <div id="header-buttons-container">
      <div id="top-row-buttons">
        <button class="button btn-blue" id="toggleHistoryBtn">å±¥æ­´</button>
        <button class="button btn-blue hidden" id="backToStartBtn">æœ€åˆã«æˆ»ã‚‹</button>
        <button class="button btn-blue hidden" id="retryBtn">é–“é•ãˆãŸå•é¡Œã«å†æŒ‘æˆ¦</button>
      </div>
      <div id="bottom-row-buttons">
        <button class="button btn-blue hidden" id="pdfBtn">PDFã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
        <button class="button btn-blue hidden" id="wrongPdfBtn">é–“é•ãˆãŸå˜èªã‚’PDFåŒ–</button>
        <button class="button btn-blue hidden" id="downloadAllBtn">å…¨å˜èªãƒªã‚¹ãƒˆã‚’PDFåŒ–</button>
      </div>
    </div>
  </header>

  <div id="start-screen" class="animate-in">
    <h1>è‹±æ¤œæº–ä¸€ç´šå˜èªã‚¯ã‚¤ã‚º</h1>
    <div id="user-selection">
        <p>Select your profile to continue.</p>
        <select id="user-select">
            <option value="">-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠ --</option>
        </select>
        <input type="password" id="passcode-input" class="hidden" placeholder="ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›" maxlength="4">
        <button class="button btn-green" id="startBtn" disabled>ãƒ­ã‚°ã‚¤ãƒ³</button>
        <p style="margin-top: 20px;"><a href="#" id="show-add-user-btn">ã¾ãŸã¯ã€æ–°ã—ã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç™»éŒ²</a></p>
    </div>
    <div id="add-user" class="hidden">
        <p>Register a new user with a 4-digit passcode.</p>
        <input type="text" id="new-user-input" placeholder="æ–°ã—ã„åå‰">
        <input type="password" id="new-user-passcode" placeholder="4æ¡ã®ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰" maxlength="4">
        <button class="button btn-blue" id="add-user-btn">ç™»éŒ²</button>
        <p style="margin-top: 20px;"><a href="#" id="back-to-select-btn">ãƒ¦ãƒ¼ã‚¶ãƒ¼é¸æŠã«æˆ»ã‚‹</a></p>
    </div>
  </div>
  
  <div class="quiz-container hidden">
    <div id="question"></div>
    <div id="input-wrapper">
      <div id="inputs"></div>
      <div id="feedback"></div>
    </div>
    <button class="button btn-green" id="submitBtn">æ±ºå®š</button>
    <button class="button btn-blue hidden" id="prevBtn">å‰ã¸</button>
    <button class="button btn-green hidden" id="nextBtn">æ¬¡ã¸</button>
    <button class="button btn-blue hidden" id="showAllBtn">çµæœã‚’ã™ã¹ã¦è¡¨ç¤º</button>
    <div id="translation"></div>
    <div class="progress-bar" id="progressBar">
      <div class="progress" id="progress"></div>
    </div>
    <div id="scoreBoard"></div>
  </div>

  <div id="history-container">
    <button id="closeHistoryBtn" title="é–‰ã˜ã‚‹">&times;</button>
    <h2>ãƒ—ãƒ¬ã‚¤å±¥æ­´<button id="clearHistoryBtn">å…¨ã¦æ¶ˆå»</button></h2>
    <input type="search" id="historySearchInput" placeholder="åå‰ã‚„æ—¥ä»˜ã§å±¥æ­´ã‚’æ¤œç´¢...">
    <ul id="history-list"></ul>
  </div>

  <script>
    const allQuestions = [
      { "sentence": "Patients are ___ to infection just after surgery.","answers": [ "vulnerable" ],"translation": "Patients are vulnerable to infection just after surgery.","jpTranslation": "æ‚£è€…ã¯æ‰‹è¡“ã®ç›´å¾Œã€æ„ŸæŸ“ç—‡ã«ã‹ã‹ã‚Šã‚„ã™ããªã‚‹ã€‚","blanksTranslation": [ "ã‹ã‹ã‚Šã‚„ã™ããªã‚‹" ] },
      { "sentence": "Make sure to ___ all the warning signs.","answers": [ "heed" ],"translation": "Make sure to heed all the warning signs.","jpTranslation": "ã™ã¹ã¦ã®è­¦æˆ’æ¨™è­˜ã«æ°—ã‚’ã¤ã‘ã‚‹ã‚ˆã†ã«ã—ã¦ãã ã•ã„ã€‚","blanksTranslation": [ "æ°—ã‚’ã¤ã‘ã‚‹" ] },
      { "sentence": "A ___ captured the arrest on video.","answers": [ "bystander" ],"translation": "A bystander captured the arrest on video.","jpTranslation": "ãã®å ´ã«å±…åˆã‚ã›ãŸäººãŒé€®æ•ã®æ§˜å­ã‚’å‹•ç”»ã«åã‚ãŸã€‚","blanksTranslation": [ "ãã®å ´ã«å±…åˆã‚ã›ãŸäºº" ] },
      { "sentence": "The bridge eases ___ in the area.","answers": [ "congestion" ],"translation": "The bridge eases congestion in the area.","jpTranslation": "ãã®æ©‹ã¯åœ°åŸŸã®æ··é›‘ã‚’ç·©å’Œã—ã¦ã„ã‚‹ã€‚","blanksTranslation": [ "æ··é›‘" ] },
      { "sentence": "She ___ all her appliances and replaced them with new ones.","answers": [ "discarded" ],"translation": "She discarded all her appliances and replaced them with new ones.","jpTranslation": "å½¼å¥³ã¯ã™ã¹ã¦ã®é›»åŒ–è£½å“ã‚’æ¨ã¦ã€æ–°ã—ã„ã‚‚ã®ã«è²·ã„æ›ãˆãŸã€‚","blanksTranslation": [ "æ¨ã¦" ] },
      { "sentence": "The ___ was completely out of control and spread quickly.","answers": [ "blaze" ],"translation": "The blaze was completely out of control and spread quickly.","jpTranslation": "ç‚ã¯å®Œå…¨ã«åˆ¶å¾¡ä¸èƒ½ã§ã€ã‚ã£ã¨ã„ã†é–“ã«ç‡ƒãˆåºƒãŒã£ãŸã€‚","blanksTranslation": [ "ç‚" ] },
      { "sentence": "He is a little ___ with a paintbrush.","answers": [ "clumsy" ],"translation": "He is a little clumsy with a paintbrush.","jpTranslation": "å½¼ã¯çµµç­†ã‚’ä½¿ã†ã®ãŒå°‘ã—ä¸å™¨ç”¨ã ã€‚","blanksTranslation": [ "ä¸å™¨ç”¨ã " ] },
      { "sentence": "We must ___ major sources of pollution quickly.","answers": [ "eliminate" ],"translation": "We must eliminate major sources of pollution quickly.","jpTranslation": "ç§ãŸã¡ã¯ä¸»è¦ãªæ±šæŸ“æºã‚’æ—©æ€¥ã«é™¤å»ã—ãªã‘ã‚Œã°ãªã‚‰ãªã„ã€‚","blanksTranslation": [ "é™¤å»ã—ãª" ] },
      { "sentence": "The politician ___ his involvement in the scandal.","answers": [ "acknowledged" ],"translation": "The politician acknowledged his involvement in the scandal.","jpTranslation": "ãã®æ”¿æ²»å®¶ã¯ã‚¹ã‚­ãƒ£ãƒ³ãƒ€ãƒ«ã¸ã®é–¢ä¸ã‚’èªã‚ãŸã€‚","blanksTranslation": [ "èªã‚ãŸ" ] },
      { "sentence": "\"Not all mushrooms are ___, so you have to be careful.\"","answers": [ "edible" ],"translation": "\"Not all mushrooms are edible, so you have to be careful.\"","jpTranslation": "ã™ã¹ã¦ã®ã‚­ãƒã‚³ãŒé£Ÿã¹ã‚‰ã‚Œã‚‹ã‚ã‘ã§ã¯ãªã„ã®ã§ã€æ³¨æ„ãŒå¿…è¦ã ã€‚","blanksTranslation": [ "é£Ÿã¹ã‚‰ã‚Œã‚‹" ] },
      { "sentence": "Our people have ___ the land here for centuries.","answers": [ "cultivated" ],"translation": "Our people have cultivated the land here for centuries.","jpTranslation": "ç§ãŸã¡ä¸€æ—ã¯ä½•ä¸–ç´€ã«ã‚‚ã‚ãŸã£ã¦ã“ã®åœŸåœ°ã‚’è€•ã—ã¦ããŸã€‚","blanksTranslation": [ "è€•ã—ã¦" ] },
      { "sentence": "She had to pay a fine because her payment was ___.","answers": [ "overdue" ],"translation": "She had to pay a fine because her payment was overdue.","jpTranslation": "æ”¯æ‰•ã„ã®æœŸé–“ãŒéãã¦ã—ã¾ã£ãŸãŸã‚ã€å½¼å¥³ã¯ç½°é‡‘ã‚’æ”¯æ‰•ã‚ãªã‘ã‚Œã°ãªã‚‰ãªã‹ã£ãŸã€‚","blanksTranslation": [ "æœŸé–“ãŒéãã¦" ] },
      { "sentence": "The university's ___ increases almost every year.","answers": [ "enrollment" ],"translation": "The university's enrollment increases almost every year.","jpTranslation": "ãã®å¤§å­¦ã®ç™»éŒ²è€…æ•°ã¯ã»ã¨ã‚“ã©æ¯å¹´å¢—ãˆã¦ã„ã‚‹ã€‚","blanksTranslation": [ "ç™»éŒ²è€…æ•°" ] },
      { "sentence": "He ___ the help of friends when setting up his business.","answers": [ "enlisted" ],"translation": "He enlisted the help of friends when setting up his business.","jpTranslation": "å½¼ã¯ä¼šç¤¾ã‚’ç«‹ã¡ä¸Šã’ã‚‹ã¨ãã«å‹äººã®æ´åŠ©ã‚’å¾—ãŸã€‚","blanksTranslation": [ "å¾—ãŸ" ] },
      { "sentence": "___ reigned in the country during the civil war.","answers": [ "Anarchy" ],"translation": "Anarchy reigned in the country during the civil war.","jpTranslation": "å†…æˆ¦ä¸­ã€å›½ã¯ç„¡æ”¿åºœçŠ¶æ…‹ã«ãªã£ãŸã€‚","blanksTranslation": [ "ç„¡æ”¿åºœçŠ¶æ…‹" ] },
      { "sentence": "She was ___ to give an answer.","answers": [ "reluctant" ],"translation": "She was reluctant to give an answer.","jpTranslation": "å½¼å¥³ã¯è¿”äº‹ã‚’ã—ãŸãŒã‚‰ãªã‹ã£ãŸã€‚","blanksTranslation": [ "ã—ãŸãŒã‚‰ãªã‹ã£ãŸ" ] },
      { "sentence": "Our company does not offer a service to ship ___ items.","answers": [ "fragile" ],"translation": "Our company does not offer a service to ship fragile items.","jpTranslation": "å½“ç¤¾ã§ã¯ã€å£Šã‚Œã‚„ã™ã„ã‚‚ã®ã®é…é€ã‚µãƒ¼ãƒ“ã‚¹ã¯è¡Œã£ã¦ãŠã‚Šã¾ã›ã‚“ã€‚","blanksTranslation": [ "å£Šã‚Œã‚„ã™ã„" ] },
      { "sentence": "Your work performance will be ___ twice per year.","answers": [ "evaluated" ],"translation": "Your work performance will be evaluated twice per year.","jpTranslation": "æ¥­ç¸¾ã¯ã€å¹´ã«2å›è©•ä¾¡ã•ã‚Œã¾ã™ã€‚","blanksTranslation": [ "è©•ä¾¡ã•ã‚Œã¾ã™" ] },
      { "sentence": "We will ___ the class at 3:00 p.m.","answers": [ "resume" ],"translation": "We will resume the class at 3:00 p.m.","jpTranslation": "åˆå¾Œ3æ™‚ã«æˆæ¥­ã‚’å†é–‹ã—ã¾ã™ã€‚","blanksTranslation": [ "å†é–‹ã—ã¾ã™" ] },
      { "sentence": "She was ___ after a day of walking in the city.","answers": [ "weary" ],"translation": "She was weary after a day of walking in the city.","jpTranslation": "å½¼å¥³ã¯ä¸€æ—¥ä¸­è¡—ã‚’æ­©ã„ã¦ç–²ã‚Œãã£ã¦ã„ãŸã€‚","blanksTranslation": [ "ç–²ã‚Œãã£ã¦ã„ãŸ" ] }
    ];
    
    const CORRECT_PASSWORD = '1234';
    let appData = { users: [], histories: {} };
    let currentPlayer = '';
    let questions = [];
    let current = 0, score = 0;
    let lastAnsweredIndex = -1;
    let userAnswers = [], incorrectQuestions = [], retryMode = false, wrongAnswers = [];
    let keyupLock = false;
    
    let titleClickCount = 0;
    let titleClickTimer = null;
    let englishVoices = [];

    const correctMessages = ["Great job!", "Awesome!", "You got it!", "Fantastic!", "Superb!"];
    const incorrectMessages = ["Nice try.", "Keep going.", "Almost!", "Not quite."];

    function getRandomItem(arr) {
        return arr[Math.floor(Math.random() * arr.length)];
    }

    const header = document.querySelector("header");
    const startScreen = document.getElementById("start-screen");
    const quizContainer = document.querySelector(".quiz-container");
    const mainTitle = document.getElementById("title");
    const startScreenTitle = document.querySelector("#start-screen h1"); 
    const qEl = document.getElementById("question");
    const inputEl = document.getElementById("inputs");
    const feedbackEl = document.getElementById("feedback");
    const translationEl = document.getElementById("translation");
    const scoreBoard = document.getElementById("scoreBoard");
    const pdfBtn = document.getElementById("pdfBtn");
    const wrongPdfBtn = document.getElementById("wrongPdfBtn");
    const retryBtn = document.getElementById("retryBtn");
    const showAllBtn = document.getElementById("showAllBtn");
    const submitBtn = document.getElementById("submitBtn");
    const nextBtn = document.getElementById("nextBtn");
    const progressBar = document.getElementById("progressBar");
    const progressEl = document.getElementById("progress");
    const downloadAllBtn = document.getElementById("downloadAllBtn");
    const backToStartBtn = document.getElementById("backToStartBtn");
    const prevBtn = document.getElementById("prevBtn");
    const toggleHistoryBtn = document.getElementById("toggleHistoryBtn");
    const historyContainer = document.getElementById("history-container");
    const clearHistoryBtn = document.getElementById("clearHistoryBtn");
    const historySearchInput = document.getElementById("historySearchInput");
    const closeHistoryBtn = document.getElementById("closeHistoryBtn");
    
    function saveAppData() {
        localStorage.setItem('quizAppData', JSON.stringify(appData));
    }

    function loadAppData() {
        const data = localStorage.getItem('quizAppData');
        if (data) {
            appData = JSON.parse(data);
            if (appData.users.length > 0 && typeof appData.users[0] === 'string') {
              console.log("Migrating old user data structure...");
              appData.users = appData.users.map(name => ({ name: name, passcode: '0000' }));
              saveAppData();
              alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿æ§‹é€ ãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸã€‚æ—¢å­˜ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä»®ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ã¯ã€Œ0000ã€ã§ã™ã€‚');
            }
        }
    }

    function populateUserDropdown() {
        const userSelect = document.getElementById('user-select');
        userSelect.innerHTML = '<option value="">-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠ --</option>';
        appData.users.forEach(user => {
            const option = document.createElement('option');
            option.value = user.name;
            option.textContent = user.name;
            userSelect.appendChild(option);
        });
    }

    function registerUser() {
        const newUserInput = document.getElementById('new-user-input');
        const newUserPasscode = document.getElementById('new-user-passcode');
        const newName = newUserInput.value.trim();
        const newPasscode = newUserPasscode.value.trim();
        
        if (!newName) {
            alert('åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
            return;
        }
        if (!newPasscode || newPasscode.length !== 4 || isNaN(newPasscode)) {
            alert('4æ¡ã®æ•°å­—ã§ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
            return;
        }
        if (appData.users.some(user => user.name === newName)) {
            alert('ã“ã®åå‰ã¯ã™ã§ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚');
            return;
        }

        appData.users.push({ name: newName, passcode: newPasscode });
        appData.histories[newName] = [];
        saveAppData();
        
        alert(`ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€Œ${newName}ã€ã‚’ç™»éŒ²ã—ã¾ã—ãŸï¼`);

        currentPlayer = newName;
        startScreen.classList.remove('animate-in');
        startScreen.classList.add('hidden');
        quizContainer.classList.remove('hidden');
        header.classList.remove('hidden');
        initQuiz();
    }

    function loadQuestion() {
      quizContainer.classList.remove('animate-in');
      void quizContainer.offsetWidth;
      quizContainer.classList.add('animate-in');

      retryBtn.classList.add("hidden");  
      prevBtn.classList.add("hidden");
      nextBtn.classList.add("hidden");
      showAllBtn.classList.add("hidden");
      qEl.style.marginBottom = "";
      translationEl.style.marginTop = "";
      
      const q = questions[current];
      
      qEl.innerHTML = `<div>Q${current + 1} / ${questions.length}: ${q.sentence}</div><div class="jp-translation">${q.jpTranslation}</div>`;
      inputEl.innerHTML = "";
      feedbackEl.textContent = "";
      feedbackEl.classList.remove('feedback-animate');
      translationEl.textContent = "";
      q.answers.forEach((_, i) => {
        const inp = document.createElement("input");
        inp.type = "text";
        inp.className = "input-field";
        inp.id = "ans" + i;
        inputEl.appendChild(inp);
      });
      const inputs = document.querySelectorAll(".input-field");
      inputs[0].focus();
      inputs.forEach((inp, idx) => {
        inp.addEventListener("keydown", e => {
          if (e.key === "Enter") {  
            e.preventDefault();  
            if (idx < inputs.length - 1) {
              inputs[idx + 1].focus();
            } else {
              keyupLock = true;
              checkAnswer();
            }
          }
        });
      });
      if (userAnswers[current]) {
          inputs.forEach((inp, i) => {
              inp.value = userAnswers[current].user[i] || "";
          });
      }
      submitBtn.classList.remove("hidden");
      const progressPercentage = (questions.length > 1) ? Math.round((current / (questions.length - 1)) * 100) : 0;
      progressEl.style.width = `${progressPercentage}%`;
    }
    function recalculateScore() {
        let newScore = 0;
        userAnswers.forEach((answer, index) => {
            if (answer && questions[index]) {
                const correctAnswers = questions[index].answers;
                const isCorrect = answer.user.every((userAns, i) => (userAns || "").toLowerCase() === (correctAnswers[i] || "").toLowerCase());
                if (isCorrect) {
                    newScore++;
                }
            }
        });
        score = newScore;
    }
    function checkAnswer() {
      const q = questions[current];
      let correct = true, answersGiven = [];
      q.answers.forEach((ans, i) => {
        const userAns = document.getElementById("ans" + i).value.trim();
        answersGiven.push(userAns);
        if (userAns.toLowerCase() !== ans.toLowerCase()) correct = false;
      });
      userAnswers[current] = { question: q.sentence, user: answersGiven, correct: q.answers };
      if (!retryMode) {
          recalculateScore();
      }
      if (!correct) {
        if (!incorrectQuestions.some(item => item.sentence === q.sentence)) incorrectQuestions.push(q);
        if (!wrongAnswers.some(item => item.sentence === q.sentence)) wrongAnswers.push(q);
      } else {
        incorrectQuestions = incorrectQuestions.filter(item => item.sentence !== q.sentence);
        wrongAnswers = wrongAnswers.filter(item => item.sentence !== q.sentence);
      }
      lastAnsweredIndex = Math.max(lastAnsweredIndex, current);
      displayAnsweredQuestion(current);
    }
    function loadNextNewQuestion() {
      current++;
      loadQuestion();
    }
    function displayAnsweredQuestion(index) {
        current = index;
        const q = questions[index];
        const recordedEntry = userAnswers[index];
        
        qEl.innerHTML = `<div>Q${current + 1} / ${questions.length}: ${q.sentence}</div><div class="jp-translation">${q.jpTranslation}</div>`;
        inputEl.innerHTML = "";
        q.answers.forEach((_, i) => {
            const inp = document.createElement("input");
            inp.type = "text";
            inp.className = "input-field";
            inp.id = "ans" + i;
            inputEl.appendChild(inp);
        });
        const inputs = inputEl.querySelectorAll(".input-field");
        inputs.forEach((inp, i) => {
            inp.value = recordedEntry.user[i] || "";
            inp.disabled = true;
            const userAnswerText = recordedEntry.user[i] || "";
            const correctAnswerText = q.answers[i] || "";
            const wasThisPartCorrect = userAnswerText.toLowerCase() === correctAnswerText.toLowerCase();
            inp.style.borderColor = wasThisPartCorrect ? 'var(--duo-green)' : 'var(--duo-red)';
            inp.style.borderWidth = '2px';
        });
        submitBtn.classList.add("hidden");
        const userWasCorrect = recordedEntry.user.join(",").toLowerCase() === recordedEntry.correct.join(",").toLowerCase();
        
        feedbackEl.className = "";
        feedbackEl.classList.add('feedback-animate');

        if (userWasCorrect) {
            confetti({ particleCount: 150, spread: 80, origin: { y: 0.6 } });
            feedbackEl.textContent = `âœ… ${getRandomItem(correctMessages)}`;
            feedbackEl.classList.add("correct");
        } else {
            feedbackEl.textContent = `âŒ ${getRandomItem(incorrectMessages)}`;
            feedbackEl.classList.add("incorrect");
        }
        let highlighted = q.translation;
        q.answers.forEach(ans => {
            const regex = new RegExp(`\\b${ans}\\b`, "gi");
            highlighted = highlighted.replace(regex, `<span style="font-weight: 900; color: red;">${ans}</span>`);
        });
        translationEl.innerHTML = `
            <p><b>è‹±æ–‡:</b> ${highlighted} <button class="button circle-button btn-green" onclick="speak('${q.translation}')">ğŸ”Š</button></p>
            <p><b>ç­”ãˆ:</b> ${q.answers.join(", ")} ${q.answers.map(ans => `<button class="button circle-button btn-green" onclick="speak('${ans}')">ğŸ”Š</button>`).join(" ")}</p>
            <p><b>æ—¥æœ¬èªè¨³:</b> ${q.blanksTranslation.join(", ")}</p>
        `;
        const isLastQuestion = index === questions.length - 1;
        prevBtn.classList.toggle("hidden", index <= 0);
        showAllBtn.classList.toggle("hidden", !isLastQuestion);
        nextBtn.classList.toggle("hidden", isLastQuestion);
    }
    function goToPreviousQuestion() {
        if (current > 0) {
            current--;
            loadQuestion();
        }
    }
    function handleNextClick() {
        if (current < lastAnsweredIndex) {
            displayAnsweredQuestion(current + 1);
        } else {
            loadNextNewQuestion();
        }
    }
    
    function showAllResults() {
        progressBar.classList.add("hidden");
        const finalScoreText = retryMode ? `${score} / ${questions.length}` : `${score} / ${allQuestions.length}`;
        const username = currentPlayer || "(No name)";

        savePlayHistory(finalScoreText);
        displayPlayHistory();
        scoreBoard.textContent = `ã‚¹ã‚³ã‚¢: ${finalScoreText}`;
        
        qEl.textContent = "å…¨çµæœ";
        inputEl.innerHTML = "";
        feedbackEl.textContent = "";
        translationEl.innerHTML = "";
        qEl.style.marginBottom = "0";
        translationEl.style.marginTop = "5px";
        translationEl.innerHTML = `<p style="margin: 0;"><b>åå‰:</b> ${username}</p><p><b>ã‚¹ã‚³ã‚¢:</b> ${finalScoreText}</p>`;
        
        userAnswers.forEach((entry, idx) => {
            if (!entry) return;
            const originalQuestion = allQuestions.find(q => q.sentence === entry.question);
            if (!originalQuestion) return;
            let highlightedSentence = originalQuestion.translation;
            originalQuestion.answers.forEach(ans => {
                const regex = new RegExp(`\\b(${ans})\\b`, 'gi');
                highlightedSentence = highlightedSentence.replace(regex, `<span style="font-weight: 900; color: red;">$1</span>`);
            });

            const userAnswersGiven = entry.user.join(", ");
            const isAnswerCorrect = userAnswersGiven.toLowerCase() === entry.correct.join(", ").toLowerCase();
            let yourAnswerHTML = isAnswerCorrect ? `<p style="margin: 5px 0;"><b>ã‚ãªãŸã®å›ç­”:</b> ${userAnswersGiven} <span style="color: var(--duo-green);">âœ…</span></p>` : `<p style="margin: 5px 0;"><b>ã‚ãªãŸã®å›ç­”:</b> <span style="color: var(--duo-red);">${userAnswersGiven || "(ç„¡å›ç­”)"}</span> âŒ</p>`;
            const div = document.createElement("div");
            div.style.cssText = "text-align: left; margin: 15px 10px; border-bottom: 1px solid #eee; padding-bottom: 10px;";
            div.innerHTML = `<p style="margin: 5px 0;"><b>Q${idx + 1}:</b> ${highlightedSentence}</p><p style="margin: 5px 0; color: #555; font-size: 14px;"><b>å’Œè¨³:</b> ${originalQuestion.jpTranslation}</p>${yourAnswerHTML}`;
            translationEl.appendChild(div);
        });

        pdfBtn.classList.remove("hidden");
        backToStartBtn.classList.remove("hidden");
        if (wrongAnswers.length > 0) wrongPdfBtn.classList.remove("hidden");
        if (incorrectQuestions.length > 0) {
            retryBtn.textContent = `é–“é•ãˆãŸ ${incorrectQuestions.length} å•ã«å†æŒ‘æˆ¦`; // <<< ã“ã“ã§ãƒœã‚¿ãƒ³åã‚’å¤‰ãˆã‚‰ã‚Œã¾ã™
            retryBtn.classList.remove("hidden");
        } else {
            retryBtn.classList.add("hidden");
        }
        showAllBtn.classList.add("hidden"); nextBtn.classList.add("hidden"); prevBtn.classList.add("hidden");
    }

    function savePlayHistory(scoreText) {
        if (!currentPlayer) return;
        const date = new Date();
        const newRecord = { 
            name: currentPlayer, 
            score: scoreText, 
            date: date.toISOString(),
            results: userAnswers 
        };
        if (!appData.histories[currentPlayer]) {
            appData.histories[currentPlayer] = [];
        }
        appData.histories[currentPlayer].unshift(newRecord);
        saveAppData();
    }

    function displayPlayHistory(searchTerm = '') {
        if (!currentPlayer) {
            document.getElementById('history-list').innerHTML = '<li>ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠã—ã¦å±¥æ­´ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚</li>';
            return;
        }
        let history = appData.histories[currentPlayer] || [];
        const historyList = document.getElementById('history-list');
        const lowerCaseSearchTerm = searchTerm.toLowerCase();

        if (lowerCaseSearchTerm) {
            history = history.filter(record => {
                const recordDate = new Date(record.date).toLocaleString();
                const recordText = `[${recordDate}] ã‚¹ã‚³ã‚¢: ${record.score}`.toLowerCase();
                return recordText.includes(lowerCaseSearchTerm);
            });
        }

        historyList.innerHTML = '';
        if (history.length === 0) {
            historyList.innerHTML = '<li>ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å±¥æ­´ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</li>';
        } else {
            history.forEach(record => {
                const listItem = document.createElement('li');
                const recordDate = new Date(record.date).toLocaleString();
                listItem.textContent = `[${recordDate}] - ã‚¹ã‚³ã‚¢: ${record.score}`;
                listItem.title = 'ã“ã®çµæœã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰';
                listItem.addEventListener('click', () => {
                downloadHistoryPDF(record);
                });
                historyList.appendChild(listItem);
            });
        }
    }
    
    function initQuiz() { 
        lastAnsweredIndex = -1; 
        score = 0; 
        userAnswers = []; 
        incorrectQuestions = []; 
        wrongAnswers = []; 
        questions = [...allQuestions]; 
        loadProgress(); 
        shuffle(questions); 
        current = 0; 
        loadQuestion(); 
    }
    function restartQuiz() { 
        window.location.reload();
    }
    function retryIncorrect() { 
        if (incorrectQuestions.length === 0) return; 
        lastAnsweredIndex = -1; 
        score = 0; 
        userAnswers = []; 
        wrongAnswers = []; 
        questions = [...incorrectQuestions]; 
        incorrectQuestions = []; 
        retryMode = true; 
        scoreBoard.textContent = ""; 
        progressBar.classList.remove("hidden"); 
        pdfBtn.classList.add("hidden"); 
        wrongPdfBtn.classList.add("hidden"); 
        retryBtn.classList.add("hidden"); 
        backToStartBtn.classList.add("hidden"); 
        quizContainer.classList.remove("hidden");
        header.classList.remove("hidden");
        current = 0; 
        loadQuestion(); 
    }
    function shuffle(array) { 
        for (let i = array.length - 1; i > 0; i--) { 
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]]; 
        } 
    }
    function saveProgress() { 
        const incorrectSentences = incorrectQuestions.map(q => q.sentence); 
        localStorage.setItem('eikenQuizIncorrect', JSON.stringify(incorrectSentences)); 
    }
    function loadProgress() {
      try {
        const savedIncorrect = localStorage.getItem('eikenQuizIncorrect');
        if (savedIncorrect) {
          const incorrectSentences = JSON.parse(savedIncorrect);
          if (Array.isArray(incorrectSentences)) {
            const loadedIncorrect = allQuestions.filter(q => incorrectSentences.includes(q.sentence));
            if (loadedIncorrect.length > 0) {
              incorrectQuestions = loadedIncorrect;
              retryBtn.textContent = `é–“é•ãˆãŸ ${incorrectQuestions.length} å•ã«å†æŒ‘æˆ¦`;
              retryBtn.classList.remove("hidden");
            }
          }
        }
      } catch (e) {
        console.error("ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:", e);
        localStorage.removeItem('eikenQuizIncorrect');
      }
    }

    function loadVoices() {
        englishVoices = speechSynthesis.getVoices().filter(voice => voice.lang.startsWith('en-'));
    }
    
    if (speechSynthesis.onvoiceschanged !== undefined) {
      speechSynthesis.onvoiceschanged = loadVoices;
    }
    loadVoices();

    function speak(text) { 
        speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        u.lang = "en-US";

        if (englishVoices.length > 0) {
            let selectedVoice = englishVoices.find(v => v.lang === "en-US" && v.name.includes("Female"));
            if (!selectedVoice) {
                selectedVoice = englishVoices.find(v => v.lang === "en-US");
            }
            if (!selectedVoice) {
                selectedVoice = englishVoices[0];
            }
            u.voice = selectedVoice;
        }
        speechSynthesis.speak(u); 
    }
    function downloadPDF() { 
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        let usernameForPdf = wanakana.isJapanese(currentPlayer) ? wanakana.toRomaji(currentPlayer) : currentPlayer;

        const finalScoreText = retryMode ? `${score} / ${questions.length}` : `${score} / ${allQuestions.length}`;
        doc.setFontSize(14);
        doc.text("Quiz Results", 10, 10);
        if (usernameForPdf) doc.text(`Name: ${usernameForPdf}`, 10, 20);
        doc.text(`Score: ${finalScoreText}`, 10, 30);
        let y = 40;
        userAnswers.forEach((entry, idx) => {
            if (!entry) return;
            const linesQ = doc.splitTextToSize(`Q${idx + 1}: ${entry.question}`, 180);
            doc.text(linesQ, 10, y); y += linesQ.length * 7;
            const linesU = doc.splitTextToSize(`Your Answer: ${entry.user.join(", ")}`, 180);
            doc.text(linesU, 10, y); y += linesU.length * 7;
            const linesC = doc.splitTextToSize(`Correct Answer: ${entry.correct.join(", ")}`, 180);
            doc.text(linesC, 10, y); y += linesC.length * 7 + 5;
            if (y > 270) { doc.addPage(); y = 20; }
        });
        doc.save("quiz_results.pdf");
    }
    function downloadWrongPDF() { 
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.setFontSize(14);
        doc.text("Wrong Vocabulary Results", 10, 10);
        let y = 20;
        wrongAnswers.forEach((q, idx) => {
            const linesQ = doc.splitTextToSize(`${idx + 1}. ${q.sentence}`, 180);
            doc.text(linesQ, 10, y); y += linesQ.length * 8;
            const linesA = doc.splitTextToSize(`Answer: ${q.answers.join(", ")}`, 180);
            doc.text(linesA, 10, y); y += linesA.length * 8 + 5;
            if (y > 270) { doc.addPage(); y = 20; }
        });
        doc.save("Wrong-vocab.pdf");
    }
    
    function downloadHistoryPDF(historyRecord) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      let usernameForPdf = wanakana.isJapanese(historyRecord.name) ? wanakana.toRomaji(historyRecord.name) : historyRecord.name;

      doc.setFontSize(16);
      doc.text("Quiz Results", 105, 15, null, null, "center");
      doc.setFontSize(12);
      doc.text(`Name: ${usernameForPdf}`, 10, 25);
      doc.text(`Score: ${historyRecord.score}`, 10, 32);
      doc.text(`Date: ${new Date(historyRecord.date).toLocaleString()}`, 10, 39);
      let y = 50; 
      historyRecord.results.forEach((entry, idx) => {
        if (!entry) return;
        if (y > 270) {
          doc.addPage();
          y = 20;
        }
        const isCorrect = entry.user.join(",").toLowerCase() === entry.correct.join(",").toLowerCase();
        doc.setFontSize(12);
        doc.text(`Q${idx + 1}: ${entry.question}`, 10, y);
        y += 7;
        doc.setFontSize(10);
        doc.setTextColor(isCorrect ? '#28a745' : '#dc3545'); 
        doc.text(`Your Answer: ${entry.user.join(", ") || "(no answer)"}`, 15, y);
        y += 7;
        if (!isCorrect) {
          doc.setTextColor('#333333'); 
          doc.text(`Correct Answer: ${entry.correct.join(", ")}`, 15, y);
          y += 7;
        }
        y += 5; 
      });
      
      const datePart = historyRecord.date.replace(/[/:\s]/g, '-');
      const namePart = usernameForPdf.replace(/\s/g, '_');
      const fileName = `${datePart}-${namePart}.pdf`;
      doc.save(fileName);
    }

    function downloadAllQuestionsPDF() { 
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.setFontSize(16);
        doc.text("Eiken Pre-1 Vocabulary List", 10, 15);
        let y = 25;
        doc.setFontSize(12);
        allQuestions.forEach((q, idx) => {
            if (y > 270) { doc.addPage(); y = 20; }
            const questionText = `${idx + 1}. ${q.sentence.replace('___', `[ ${q.answers[0]} ]`)}`;
            const linesQ = doc.splitTextToSize(questionText, 180);
            doc.text(linesQ, 10, y);
            y += linesQ.length * 7 + 5;
        });
        doc.save("Eiken-Pre-1-Vocab-List.pdf");
    }

    // --- Event Listeners ---
    pdfBtn.onclick = downloadPDF;
    wrongPdfBtn.onclick = downloadWrongPDF;
    submitBtn.onclick = checkAnswer;
    nextBtn.onclick = handleNextClick;
    prevBtn.onclick = goToPreviousQuestion;
    showAllBtn.onclick = showAllResults;
    retryBtn.onclick = retryIncorrect;
    downloadAllBtn.onclick = downloadAllQuestionsPDF;
    backToStartBtn.onclick = restartQuiz;

    toggleHistoryBtn.addEventListener('click', () => {
      if (historyContainer.classList.contains('show')) {
        historyContainer.classList.remove('show');
      } 
      else {
        const inputPassword = prompt('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
        if (inputPassword === null) return;

        if (inputPassword === CORRECT_PASSWORD) {
          historyContainer.classList.add('show');
        } else {
          alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™ã€‚');
        }
      }
    });

    closeHistoryBtn.onclick = () => {
      historyContainer.classList.remove('show');
    };

    clearHistoryBtn.addEventListener('click', () => {
      if (!currentPlayer) {
            alert('å±¥æ­´ã‚’æ¶ˆå»ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
            return;
        }
      const inputPassword = prompt('å±¥æ­´ã‚’å‰Šé™¤ã™ã‚‹ã«ã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
      if (inputPassword === null) return;
      
      if (inputPassword === CORRECT_PASSWORD) {
        if (confirm(`æœ¬å½“ã«ã€Œ${currentPlayer}ã€ã®å±¥æ­´ã‚’ã™ã¹ã¦æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ`)) {
          appData.histories[currentPlayer] = [];
          saveAppData();
          displayPlayHistory();
          alert('å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚');
        }
      } else {
        alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™ã€‚');
      }
    });
    
    function secretClickHandler() {
      titleClickCount++;
      clearTimeout(titleClickTimer);
      titleClickTimer = setTimeout(() => {
        titleClickCount = 0;
      }, 1500);

      if (titleClickCount >= 5) {
        titleClickCount = 0;
        clearTimeout(titleClickTimer);
        toggleHistoryBtn.click();
      }
    }

    mainTitle.addEventListener('click', secretClickHandler);
    startScreenTitle.addEventListener('click', secretClickHandler);

    document.addEventListener('keyup', (event) => {
        if (event.key !== 'Enter') return;
        if (keyupLock) {
            keyupLock = false;
            return;
        }
        if (document.activeElement && document.activeElement.tagName === 'INPUT') {
            return;
        }
        if (!nextBtn.classList.contains('hidden')) {
            handleNextClick();
        } 
        else if (!showAllBtn.classList.contains('hidden')) {
            showAllResults();
        }
    });

    document.addEventListener('DOMContentLoaded', () => {
        loadAppData();
        populateUserDropdown();
        displayPlayHistory();

        const userSelect = document.getElementById('user-select');
        const showAddUserBtn = document.getElementById('show-add-user-btn');
        const addUserSection = document.getElementById('add-user');
        const userSelectionSection = document.getElementById('user-selection');
        const backToSelectBtn = document.getElementById('back-to-select-btn');
        const addUserBtn = document.getElementById('add-user-btn');
        const newUserInput = document.getElementById('new-user-input');
        const newUserPasscode = document.getElementById('new-user-passcode');
        const startBtn = document.getElementById('startBtn');
        const passcodeInput = document.getElementById('passcode-input');

        userSelect.addEventListener('change', () => {
            const selectedName = userSelect.value;
            passcodeInput.value = '';
            if (selectedName) {
                passcodeInput.classList.remove('hidden');
                passcodeInput.focus();
                startBtn.disabled = true;
            } else {
                passcodeInput.classList.add('hidden');
                startBtn.disabled = true;
            }
        });

        passcodeInput.addEventListener('input', () => {
            startBtn.disabled = passcodeInput.value.length === 0;
        });
        
        showAddUserBtn.addEventListener('click', (e) => {
            e.preventDefault();
            userSelectionSection.classList.add('hidden');
            addUserSection.classList.remove('hidden');
            newUserInput.focus();
        });
        backToSelectBtn.addEventListener('click', (e) => {
            e.preventDefault();
            addUserSection.classList.add('hidden');
            userSelectionSection.classList.remove('hidden');
        });
        
        addUserBtn.addEventListener('click', registerUser);
        newUserPasscode.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault();
                registerUser();
            }
        });

        startBtn.addEventListener('click', () => {
            const selectedName = userSelect.value;
            const enteredPasscode = passcodeInput.value;
            const user = appData.users.find(u => u.name === selectedName);

            if (user && enteredPasscode === user.passcode) {
                currentPlayer = selectedName;
                startScreen.classList.remove('animate-in');
                startScreen.classList.add('hidden');
                quizContainer.classList.remove('hidden');
                header.classList.remove('hidden');
                initQuiz();
            } else {
                alert('ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™ã€‚');
                passcodeInput.value = '';
                passcodeInput.focus();
            }
        });
    });
    
    historySearchInput.addEventListener('input', () => {
      displayPlayHistory(historySearchInput.value);
    });
  </script>
</body>
</html>
