<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è‹±æ¤œæº–ä¸€ç´šå˜èªã‚¯ã‚¤ã‚º</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin: 0;
      padding: 0; 
      background: linear-gradient(to bottom, #e0ffe0, #ffffff);
      color: #333;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    header {
      background: #ffffff;  
      padding: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      border-bottom: 1px solid #ddd;
      position: relative; 
      z-index: 10;
      width: 100%;
      box-sizing: border-box;
    }
    #title {
      flex-grow: 1;
      text-align: center;
      font-size: 28px;
      font-weight: bold;
      color: #333;
    }

    #start-screen {
      max-width: 800px;
      margin: 40px auto;
      padding: 40px;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    #start-screen h1 {
      font-size: 32px;
      margin-bottom: 15px;
    }
    #start-screen p {
      font-size: 18px;
      margin-bottom: 30px;
    }
    #username {
      padding: 12px;
      font-size: 20px;
      width: 300px;
      border: 1px solid #ccc;
      border-radius: 5px;
      display: block;
      margin: 0 auto 20px;
    }
    
    .quiz-container {
      max-width: 800px;
      width: 100%;
      min-height: 600px;
      margin: 20px auto;
      padding: 20px;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      box-sizing: border-box;
    }
    .input-field {
      margin: 10px;
      padding: 10px;
      font-size: 22px;
      width: 200px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    .input-field:disabled {
        background-color: #f2f2f2;
        color: #555;
    }
    .button {
      margin: 0 5px;
      padding: 8px 16px;
      font-size: 16px;
      cursor: pointer;
      border: none;
      border-radius: 8px;
      background: #007BFF;
      color: white;
      transition: background-color 0.2s;
    }
    .button:hover {
        background: #0056b3;
    }

    #header-buttons-container {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
    }
    #header-buttons-container div {
      margin-bottom: 5px;
    }
    #header-buttons-container div:last-child {
      margin-bottom: 0;
    }

    .circle-button {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: none;
      margin-left: 8px;
      cursor: pointer;
      background-color: #007BFF;
      color: white;
      font-size: 14px;
      transition: background-color 0.2s;
    }
    .circle-button:hover {
        background: #0056b3;
    }
    .hidden { display: none; }
    #question { font-size: 24px; margin-bottom: 20px; }
    #question .jp-translation {
      font-size: 18px;
      color: #555;
      margin-top: 8px;
    }
    #translation { font-size: 20px; margin-top: 15px; }
    #input-wrapper {
      position: relative;
      min-height: 60px;
    }
    #feedback {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(120px, -50%);
      width: 160px;
      text-align: left;
      font-size: 20px;
      font-weight: bold;
    }
    #feedback.correct { color: #28a745; }
    #feedback.incorrect { color: #dc3545; }
    .progress-bar {
      height: 25px;
      background-color: #e9ecef;
      border-radius: 10px;
      margin-top: 20px;
      overflow: hidden;
    }
    .progress {
      height: 100%;
      width: 0%;
      background-color: #007BFF;
      border-radius: 10px;
      transition: width 0.4s ease-in-out;
    }

    #history-container {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      max-height: 250px;
      overflow-y: auto;
      background-color: #f0f0f0;
      border-top: 2px solid #ccc;
      padding: 10px;
      box-sizing: border-box;
      text-align: left;
      transform: translateY(100%); 
      transition: transform 0.3s ease-in-out; 
      z-index: 100;
    }
    #history-container.show {
      transform: translateY(0);
    }
    
    #history-container h2 {
      margin-top: 0;
      margin-bottom: 10px;
      text-align: center;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    #history-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    #history-list li {
      background-color: #fff;
      padding: 8px;
      border-bottom: 1px solid #ddd;
      font-size: 14px;
      cursor: pointer; 
      transition: background-color 0.2s;
    }
    #history-list li:hover {
      background-color: #e9ecef; 
    }

    #clearHistoryBtn {
      font-size: 12px;
      padding: 4px 8px;
      background-color: #dc3545;
      border: none;
      color: white;
      border-radius: 5px;
      cursor: pointer;
      margin-left: 15px;
    }
    #clearHistoryBtn:hover {
      background-color: #c82333;
    }

    #historySearchInput {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
      box-sizing: border-box;
    }

    @media (max-width: 768px) {
      header {
        flex-direction: column;
        padding: 10px 5px;
      }
      #title {
        font-size: 20px;
        margin-bottom: 10px;
      }
      #header-buttons-container {
        align-items: center;
      }
      .button {
        padding: 10px 12px;
        font-size: 14px;
      }

      #start-screen, .quiz-container {
        width: 95%;
        margin: 10px auto;
        padding: 15px;
        min-height: 0;
      }
      #start-screen h1 {
        font-size: 24px;
      }

      #username, .input-field {
        width: 90%;
        box-sizing: border-box;
        font-size: 18px;
      }

      #question {
        font-size: 18px;
      }
      #feedback {
        position: static;
        transform: none;
        text-align: center;
        width: 100%;
        margin-top: 10px;
        font-size: 18px;
      }
      #input-wrapper {
        min-height: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      #history-container {
        max-height: 40%;
      }
    }

  </style>
</head>
<body>
  <header class="hidden">
    <div id="title">è‹±æ¤œæº–ä¸€ç´šå˜èªã‚¯ã‚¤ã‚º</div>
    <div id="header-buttons-container">
      <div id="top-row-buttons">
        <button class="button" id="toggleHistoryBtn">å±¥æ­´ã‚’è¦‹ã‚‹</button>
        <button class="button hidden" id="backToStartBtn">æœ€åˆã«æˆ»ã‚‹</button>
        <button class="button hidden" id="retryBtn">é–“é•ãˆãŸå•é¡Œã«å†æŒ‘æˆ¦</button>
      </div>
      <div id="bottom-row-buttons">
        <button class="button hidden" id="pdfBtn">Download PDF</button>
        <button class="button hidden" id="wrongPdfBtn">Download Wrong-vocab</button>
        <button class="button hidden" id="downloadAllBtn">å…¨å˜èªãƒªã‚¹ãƒˆã‚’PDFåŒ–</button>
      </div>
    </div>
  </header>

  <div id="start-screen">
    <h1>è‹±æ¤œæº–ä¸€ç´šå˜èªã‚¯ã‚¤ã‚º</h1>
    <p>Please enter your name to start the quiz.</p>
    <input type="text" id="username" placeholder="Enter your name">
    <button class="button" id="startBtn">Start Quiz</button>
  </div>
  
  <div class="quiz-container hidden">
    <div id="question"></div>
    <div id="input-wrapper">
      <div id="inputs"></div>
      <div id="feedback"></div>
    </div>
    <button class="button" id="submitBtn">Submit</button>
    <button class="button hidden" id="prevBtn">å‰ã®å•é¡Œã¸</button>
    <button class="button hidden" id="nextBtn">Next</button>
    <button class="button hidden" id="showAllBtn">Show All Results</button>
    <div id="translation"></div>
    <div class="progress-bar" id="progressBar">
      <div class="progress" id="progress"></div>
    </div>
    <div id="scoreBoard"></div>
  </div>

  <div id="history-container">
    <h2>ãƒ—ãƒ¬ã‚¤å±¥æ­´<button id="clearHistoryBtn">å…¨æ¶ˆå»</button></h2>
    <input type="search" id="historySearchInput" placeholder="åå‰ã‚„æ—¥ä»˜ã§å±¥æ­´ã‚’æ¤œç´¢...">
    <ul id="history-list"></ul>
  </div>

  <script>
    // â–¼â–¼â–¼ å¤‰æ›´ç‚¹ â–¼â–¼â–¼ (æœ€æ–°ã®JSONãƒ‡ãƒ¼ã‚¿ã‚’ã“ã“ã«åæ˜ )
    const allQuestions = [
      {
        "sentence": "Patients are ___ to infection just after surgery.",
        "answers": [ "vulnerable" ],
        "translation": "Patients are vulnerable to infection just after surgery.",
        "jpTranslation": "æ‚£è€…ã¯æ‰‹è¡“ã®ç›´å¾Œã€æ„ŸæŸ“ç—‡ã«ã‹ã‹ã‚Šã‚„ã™ããªã‚‹ã€‚",
        "blanksTranslation": [ "å‚·ã¤ãã‚„ã™ã„ã€ã‹ã‹ã‚Šã‚„ã™ã„" ]
      },
      {
        "sentence": "Make sure to ___ all the warning signs.",
        "answers": [ "heed" ],
        "translation": "Make sure to heed all the warning signs.",
        "jpTranslation": "ã™ã¹ã¦ã®è­¦æˆ’æ¨™è­˜ã«æ°—ã‚’ã¤ã‘ã‚‹ã‚ˆã†ã«ã—ã¦ãã ã•ã„ã€‚",
        "blanksTranslation": [ "ã€œã«æ°—ã‚’ã¤ã‘ã‚‹ã€ã‚’å¿ƒã«ç•™ã‚ã‚‹" ]
      },
      {
        "sentence": "A ___ captured the arrest on video.",
        "answers": [ "bystander" ],
        "translation": "A bystander captured the arrest on video.",
        "jpTranslation": "ãã®å ´ã«å±…åˆã‚ã›ãŸäººãŒé€®æ•ã®æ§˜å­ã‚’å‹•ç”»ã«åã‚ãŸã€‚",
        "blanksTranslation": [ "å‚è¦³è€…ã€è¦‹ç‰©äºº" ]
      },
      {
        "sentence": "The bridge eases ___ in the area.",
        "answers": [ "congestion" ],
        "translation": "The bridge eases congestion in the area.",
        "jpTranslation": "ãã®æ©‹ã¯åœ°åŸŸã®æ··é›‘ã‚’ç·©å’Œã—ã¦ã„ã‚‹ã€‚",
        "blanksTranslation": [ "æ··é›‘" ]
      },
      {
        "sentence": "She ___ all her appliances and replaced them with new ones.",
        "answers": [ "discarded" ],
        "translation": "She discarded all her appliances and replaced them with new ones.",
        "jpTranslation": "å½¼å¥³ã¯ã™ã¹ã¦ã®é›»åŒ–è£½å“ã‚’æ¨ã¦ã€æ–°ã—ã„ã‚‚ã®ã«è²·ã„æ›ãˆãŸã€‚",
        "blanksTranslation": [ "ã€œã‚’æ¨ã¦ã‚‹ã€å‡¦åˆ†ã™ã‚‹" ]
      },
      {
        "sentence": "The ___ was completely out of control and spread quickly.",
        "answers": [ "blaze" ],
        "translation": "The blaze was completely out of control and spread quickly.",
        "jpTranslation": "ç‚ã¯å®Œå…¨ã«åˆ¶å¾¡ä¸èƒ½ã§ã€ã‚ã£ã¨ã„ã†é–“ã«ç‡ƒãˆåºƒãŒã£ãŸã€‚",
        "blanksTranslation": [ "ç‚ã€ç«ç‚" ]
      },
      {
        "sentence": "He is a little ___ with a paintbrush.",
        "answers": [ "clumsy" ],
        "translation": "He is a little clumsy with a paintbrush.",
        "jpTranslation": "å½¼ã¯çµµç­†ã‚’ä½¿ã†ã®ãŒå°‘ã—ä¸å™¨ç”¨ã ã€‚",
        "blanksTranslation": [ "ä¸å™¨ç”¨ãªã€ãã“ã¡ãªã„" ]
      },
      {
        "sentence": "We must ___ major sources of pollution quickly.",
        "answers": [ "eliminate" ],
        "translation": "We must eliminate major sources of pollution quickly.",
        "jpTranslation": "ç§ãŸã¡ã¯ä¸»è¦ãªæ±šæŸ“æºã‚’æ—©æ€¥ã«é™¤å»ã—ãªã‘ã‚Œã°ãªã‚‰ãªã„ã€‚",
        "blanksTranslation": [ "ã€œã‚’å–ã‚Šé™¤ãã€å¤–ã™" ]
      },
      {
        "sentence": "The politician ___ his involvement in the scandal.",
        "answers": [ "acknowledged" ],
        "translation": "The politician acknowledged his involvement in the scandal.",
        "jpTranslation": "ãã®æ”¿æ²»å®¶ã¯ã‚¹ã‚­ãƒ£ãƒ³ãƒ€ãƒ«ã¸ã®é–¢ä¸ã‚’èªã‚ãŸã€‚",
        "blanksTranslation": [ "ã€œã‚’èªã‚ã‚‹" ]
      },
      {
        "sentence": "\"Not all mushrooms are ___, so you have to be careful.\"",
        "answers": [ "edible" ],
        "translation": "\"Not all mushrooms are edible, so you have to be careful.\"",
        "jpTranslation": "ã™ã¹ã¦ã®ã‚­ãƒã‚³ãŒé£Ÿã¹ã‚‰ã‚Œã‚‹ã‚ã‘ã§ã¯ãªã„ã®ã§ã€æ³¨æ„ãŒå¿…è¦ã ã€‚",
        "blanksTranslation": [ "é£Ÿã¹ã‚‰ã‚Œã‚‹" ]
      },
      {
        "sentence": "Our people have ___ the land here for centuries.",
        "answers": [ "cultivated" ],
        "translation": "Our people have cultivated the land here for centuries.",
        "jpTranslation": "ç§ãŸã¡ä¸€æ—ã¯ä½•ä¸–ç´€ã«ã‚‚ã‚ãŸã£ã¦ã“ã®åœŸåœ°ã‚’è€•ã—ã¦ããŸã€‚",
        "blanksTranslation": [ "(åœŸåœ°)ã‚’è€•ã™" ]
      },
      {
        "sentence": "She had to pay a fine because her payment was ___.",
        "answers": [ "overdue" ],
        "translation": "She had to pay a fine because her payment was overdue.",
        "jpTranslation": "æ”¯æ‰•ã„ã®æœŸé–“ãŒéãã¦ã—ã¾ã£ãŸãŸã‚ã€å½¼å¥³ã¯ç½°é‡‘ã‚’æ”¯æ‰•ã‚ãªã‘ã‚Œã°ãªã‚‰ãªã‹ã£ãŸã€‚",
        "blanksTranslation": [ "æœŸé™ãŒéãã¦" ]
      },
      {
        "sentence": "The university's ___ increases almost every year.",
        "answers": [ "enrollment" ],
        "translation": "The university's enrollment increases almost every year.",
        "jpTranslation": "ãã®å¤§å­¦ã®ç™»éŒ²è€…æ•°ã¯ã»ã¨ã‚“ã©æ¯å¹´å¢—ãˆã¦ã„ã‚‹ã€‚",
        "blanksTranslation": [ "ç™»éŒ²ã€å…¥å­¦" ]
      },
      {
        "sentence": "He ___ the help of friends when setting up his business.",
        "answers": [ "enlisted" ],
        "translation": "He enlisted the help of friends when setting up his business.",
        "jpTranslation": "å½¼ã¯ä¼šç¤¾ã‚’ç«‹ã¡ä¸Šã’ã‚‹ã¨ãã«å‹äººã®æ´åŠ©ã‚’å¾—ãŸã€‚",
        "blanksTranslation": [ "(æ´åŠ©ãªã©)ã‚’å¾—ã‚‹ã€æ±‚ã‚ã‚‹" ]
      },
      {
        "sentence": "___ reigned in the country during the civil war.",
        "answers": [ "Anarchy" ],
        "translation": "Anarchy reigned in the country during the civil war.",
        "jpTranslation": "å†…æˆ¦ä¸­ã€å›½ã¯ç„¡æ”¿åºœçŠ¶æ…‹ã«ãªã£ãŸã€‚",
        "blanksTranslation": [ "ç„¡æ”¿åºœçŠ¶æ…‹" ]
      },
      {
        "sentence": "She was ___ to give an answer.",
        "answers": [ "reluctant" ],
        "translation": "She was reluctant to give an answer.",
        "jpTranslation": "å½¼å¥³ã¯è¿”äº‹ã‚’ã—ãŸãŒã‚‰ãªã‹ã£ãŸã€‚",
        "blanksTranslation": [ "æ°—ä¹—ã‚ŠãŒã—ãªã„ã€ã—ã¶ã—ã¶ã®" ]
      },
      {
        "sentence": "Our company does not offer a service to ship ___ items.",
        "answers": [ "fragile" ],
        "translation": "Our company does not offer a service to ship fragile items.",
        "jpTranslation": "å½“ç¤¾ã§ã¯ã€å£Šã‚Œã‚„ã™ã„ã‚‚ã®ã®é…é€ã‚µãƒ¼ãƒ“ã‚¹ã¯è¡Œã£ã¦ãŠã‚Šã¾ã›ã‚“ã€‚",
        "blanksTranslation": [ "å£Šã‚Œã‚„ã™ã„" ]
      },
      {
        "sentence": "Your work performance will be ___ twice per year.",
        "answers": [ "evaluated" ],
        "translation": "Your work performance will be evaluated twice per year.",
        "jpTranslation": "æ¥­ç¸¾ã¯ã€å¹´ã«2å›è©•ä¾¡ã•ã‚Œã¾ã™ã€‚",
        "blanksTranslation": [ "ã€œã‚’è©•ä¾¡ã™ã‚‹" ]
      },
      {
        "sentence": "We will ___ the class at 3:00 p.m.",
        "answers": [ "resume" ],
        "translation": "We will resume the class at 3:00 p.m.",
        "jpTranslation": "åˆå¾Œ3æ™‚ã«æˆæ¥­ã‚’å†é–‹ã—ã¾ã™ã€‚",
        "blanksTranslation": [ "ã€œã‚’å†é–‹ã™ã‚‹" ]
      },
      {
        "sentence": "She was ___ after a day of walking in the city.",
        "answers": [ "weary" ],
        "translation": "She was weary after a day of walking in the city.",
        "jpTranslation": "å½¼å¥³ã¯ä¸€æ—¥ä¸­è¡—ã‚’æ­©ã„ã¦ç–²ã‚Œãã£ã¦ã„ãŸã€‚",
        "blanksTranslation": [ "ã²ã©ãç–²ã‚ŒãŸ" ]
      },
      {
        "sentence": "Her grandparents took ___ of her after the accident.",
        "answers": [ "custody" ],
        "translation": "Her grandparents took custody of her after the accident.",
        "jpTranslation": "äº‹æ•…ã®ã‚ã¨ã€ç¥–çˆ¶æ¯ãŒå½¼å¥³ã‚’ä¿è­·ã—ãŸã€‚",
        "blanksTranslation": [ "ä¿è­·ã€è¦ªæ¨©" ]
      },
      {
        "sentence": "The two parties formed a ___ government.",
        "answers": [ "coalition" ],
        "translation": "The two parties formed a coalition government.",
        "jpTranslation": "ãã®2ã¤ã®æ”¿å…šã¯é€£ç«‹æ”¿æ¨©ã‚’æ¨¹ç«‹ã—ãŸã€‚",
        "blanksTranslation": [ "é€£ç«‹ã€é€£åˆ" ]
      },
      {
        "sentence": "\"That area has many large, ___ forests.\"",
        "answers": [ "tranquil" ],
        "translation": "\"That area has many large, tranquil forests.\"",
        "jpTranslation": "ãã®åœ°åŸŸã«ã¯ã€å¤§ããã¦é™ã‹ãªæ£®ãŒãŸãã•ã‚“ã‚ã‚‹ã€‚",
        "blanksTranslation": [ "é™ã‹ãªã€ç©ã‚„ã‹ãª" ]
      },
      {
        "sentence": "It is the job of the police to ___ the law.",
        "answers": [ "enforce" ],
        "translation": "It is the job of the police to enforce the law.",
        "jpTranslation": "æ³•å¾‹ã‚’éµå®ˆã•ã›ã‚‹ã®ã¯è­¦å¯Ÿã®ä»•äº‹ã ã€‚",
        "blanksTranslation": [ "(æ³•å¾‹ãªã©)ã‚’å®ˆã‚‰ã›ã‚‹ã€æ–½è¡Œã™ã‚‹" ]
      },
      {
        "sentence": "The woman ___ herself as a man to avoid police.",
        "answers": [ "disguised" ],
        "translation": "The woman disguised herself as a man to avoid police.",
        "jpTranslation": "ãã®å¥³æ€§ã¯è­¦å¯Ÿã®ç›®ã‚’é¿ã‘ã‚‹ãŸã‚ã«ç”·æ€§ã«å¤‰è£…ã—ãŸã€‚",
        "blanksTranslation": [ "ã€œã‚’å¤‰è£…ã•ã›ã‚‹ã€å½è£…ã™ã‚‹" ]
      },
      {
        "sentence": "The school plans to use the ___ of funds to update the gymnasium.",
        "answers": [ "surplus" ],
        "translation": "The school plans to use the surplus of funds to update the gymnasium.",
        "jpTranslation": "ãã®å­¦æ ¡ã¯ã€ä½™å‰°é‡‘ã‚’ä½¿ã£ã¦ä½“è‚²é¤¨ã‚’æ”¹ä¿®ã™ã‚‹äºˆå®šã ã€‚",
        "blanksTranslation": [ "ä½™å‰°ã€ä½™å‰°åˆ†" ]
      },
      {
        "sentence": "The activists are looking for more people to sign their ___.",
        "answers": [ "petition" ],
        "translation": "The activists are looking for more people to sign their petition.",
        "jpTranslation": "æ´»å‹•å®¶ãŸã¡ã¯å˜†é¡˜æ›¸ã«ç½²åã—ã¦ãã‚Œã‚‹ã•ã‚‰ã«å¤šãã®äººã‚’æ¢ã—ã¦ã„ã‚‹ã€‚",
        "blanksTranslation": [ "å˜†é¡˜æ›¸" ]
      },
      {
        "sentence": "He is a ___ late sleeper and is often late to work.",
        "answers": [ "habitual" ],
        "translation": "He is a habitual late sleeper and is often late to work.",
        "jpTranslation": "å½¼ã¯å¯åŠã®å¸¸ç¿’çŠ¯ã§ã€ã‚ˆãä»•äº‹ã«é…åˆ»ã™ã‚‹ã€‚",
        "blanksTranslation": [ "å¸¸ç¿’çš„ãªã€ç¿’æ…£çš„ãª" ]
      },
      {
        "sentence": "\"The building is new, so there are still several ___ apartments.\"",
        "answers": [ "vacant" ],
        "translation": "\"The building is new, so there are still several vacant apartments.\"",
        "jpTranslation": "ãã®ãƒ“ãƒ«ã¯æ–°ã—ã„ã®ã§ã€ã¾ã ã„ãã¤ã‹ç©ºãéƒ¨å±‹ãŒã‚ã‚‹ã€‚",
        "blanksTranslation": [ "ç©ºã„ã¦ã„ã‚‹ã€ä½¿ã‚ã‚Œã¦ã„ãªã„" ]
      },
      {
        "sentence": "Critics have praised the author's ___ use of poetic language.",
        "answers": [ "daring" ],
        "translation": "Critics have praised the author's daring use of poetic language.",
        "jpTranslation": "æ‰¹è©•å®¶ãŸã¡ã¯ã€ãã®è‘—è€…ã®å¤§èƒ†ãªè©©çš„è¨€è‘‰é£ã„ã‚’ç§°è³›ã—ã¦ã„ã‚‹ã€‚",
        "blanksTranslation": [ "å¤§èƒ†ãª" ]
      },
      {
        "sentence": "The company's business activities are ___ in Southeast Asia.",
        "answers": [ "thriving" ],
        "translation": "The company's business activities are thriving in Southeast Asia.",
        "jpTranslation": "ãã®ä¼šç¤¾ã®äº‹æ¥­æ´»å‹•ã¯æ±å—ã‚¢ã‚¸ã‚¢ã§æˆåŠŸã—ã¦ã„ã‚‹ã€‚",
        "blanksTranslation": [ "ç¹æ „ã™ã‚‹ã€æˆåŠŸã™ã‚‹" ]
      },
      {
        "sentence": "She has a large purse divided into several ___.",
        "answers": [ "compartments" ],
        "translation": "She has a large purse divided into several compartments.",
        "jpTranslation": "å½¼å¥³ã¯ã„ãã¤ã‹ã®ä»•åˆ‡ã‚Šã«åˆ†ã‹ã‚ŒãŸå¤§ããªãƒãƒ³ãƒ‰ãƒãƒƒã‚°ã‚’æŒã£ã¦ã„ã‚‹ã€‚",
        "blanksTranslation": [ "ä»•åˆ‡ã‚‰ã‚ŒãŸéƒ¨åˆ†" ]
      },
      {
        "sentence": "The growth of the economy continues to ___ rapidly.",
        "answers": [ "accelerate" ],
        "translation": "The growth of the economy continues to accelerate rapidly.",
        "jpTranslation": "çµŒæ¸ˆæˆé•·ã¯æ€¥é€Ÿã«åŠ é€Ÿã—ç¶šã‘ã¦ã„ã‚‹ã€‚",
        "blanksTranslation": [ "åŠ é€Ÿã™ã‚‹" ]
      },
      {
        "sentence": "Most people in this neighborhood are ___ of Japanese immigrants.",
        "answers": [ "descendants" ],
        "translation": "Most people in this neighborhood are descendants of Japanese immigrants.",
        "jpTranslation": "ã“ã®ç•Œéšˆã®ã»ã¨ã‚“ã©ã®äººã¯æ—¥æœ¬ã‹ã‚‰ã®ç§»æ°‘ã®å­å­«ã ã€‚",
        "blanksTranslation": [ "å­å­«ã€æœ«è£”" ]
      },
      {
        "sentence": "The old barn ___ until there was nothing left.",
        "answers": [ "decayed" ],
        "translation": "The old barn decayed until there was nothing left.",
        "jpTranslation": "å¤ã„ç´å±‹ã¯æœ½ã¡æœã¦ã¦ã€æœ€å¾Œã«ã¯ä½•ã‚‚æ®‹ã‚‰ãªã‹ã£ãŸã€‚",
        "blanksTranslation": [ "è…ã‚‹ã€æœ½ã¡ã‚‹" ]
      },
      {
        "sentence": "Our smartphone designs are constantly being ___ and improved.",
        "answers": [ "refined" ],
        "translation": "Our smartphone designs are constantly being refined and improved.",
        "jpTranslation": "å½“ç¤¾ã®ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ã®ãƒ‡ã‚¶ã‚¤ãƒ³ã¯ã€çµ¶ãˆãšæ´—ç·´ã¨æ”¹è‰¯ã‚’ç¶šã‘ã¦ãŠã‚Šã¾ã™ã€‚",
        "blanksTranslation": [ "ã€œã‚’æ´—ç·´ã™ã‚‹ã€æ”¹è‰¯ã™ã‚‹" ]
      },
      {
        "sentence": "The bug bites on her legs ___ and turned red.",
        "answers": [ "swelled" ],
        "translation": "The bug bites on her legs swelled and turned red.",
        "jpTranslation": "å½¼å¥³ã®ä¸¡è„šã®è™«åˆºã•ã‚Œã¯ã€è…«ã‚Œã¦èµ¤ããªã£ãŸã€‚",
        "blanksTranslation": [ "è…«ã‚Œã‚‹" ]
      },
      {
        "sentence": "A large ___ of the population does not have access to clean water.",
        "answers": [ "segment" ],
        "translation": "A large segment of the population does not have access to clean water.",
        "jpTranslation": "äººå£ã®å¤§éƒ¨åˆ†ã¯ãã‚Œã„ãªæ°´ã‚’æ‰‹ã«å…¥ã‚Œã‚‹ã“ã¨ãŒã§ããªã„ã€‚",
        "blanksTranslation": [ "éƒ¨åˆ†ã€åŒºåˆ†" ]
      },
      {
        "sentence": "Several politicians have been arrested for taking ___.",
        "answers": [ "bribes" ],
        "translation": "Several politicians have been arrested for taking bribes.",
        "jpTranslation": "è³„è³‚ã‚’å—ã‘å–ã£ãŸã¨ã—ã¦ä½•äººã‹ã®æ”¿æ²»å®¶ãŒé€®æ•ã•ã‚ŒãŸã€‚",
        "blanksTranslation": [ "è³„è³‚" ]
      },
      {
        "sentence": "She has been ___ with comic books since she was young.",
        "answers": [ "obsessed" ],
        "translation": "She has been obsessed with comic books since she was young.",
        "jpTranslation": "å½¼å¥³ã¯å¹¼ã„ã“ã‚ã‹ã‚‰ãšã£ã¨æ¼«ç”»ã«å¤¢ä¸­ã ã€‚",
        "blanksTranslation": [ "å¿ƒã‚’å¥ªã‚ã‚ŒãŸã€å–ã‚Šã¤ã‹ã‚ŒãŸ" ]
      },
      {
        "sentence": "The CEO ___ his promise to avoid company-wide layoffs.",
        "answers": [ "upheld" ],
        "translation": "The CEO upheld his promise to avoid company-wide layoffs.",
        "jpTranslation": "CEOã¯ã€å…¨ç¤¾çš„ãªè§£é›‡ã‚’å›é¿ã™ã‚‹ã¨ã„ã†ç´„æŸã‚’å®ˆã£ãŸã€‚",
        "blanksTranslation": [ "(å…¬ç´„ãªã©)ã‚’å®ˆã‚‹" ]
      },
      {
        "sentence": "The organization is trying to ___ the government.",
        "answers": [ "overthrow" ],
        "translation": "The organization is trying to overthrow the government.",
        "jpTranslation": "ãã®çµ„ç¹”ã¯æ”¿åºœã‚’è»¢è¦†ã•ã›ã‚ˆã†ã¨ã—ã¦ã„ã‚‹ã€‚",
        "blanksTranslation": [ "(æ”¿åºœãªã©)ã‚’è»¢è¦†ã•ã›ã‚‹" ]
      },
      {
        "sentence": "He let his wife decide the ___ for their trip to Europe.",
        "answers": [ "itinerary" ],
        "translation": "He let his wife decide the itinerary for their trip to Europe.",
        "jpTranslation": "å½¼ã¯ãƒ¨ãƒ¼ãƒ­ãƒƒãƒ‘æ—…è¡Œã®è¨ˆç”»ã‚’å¦»ã«ä»»ã›ãŸã€‚",
        "blanksTranslation": [ "æ—…ç¨‹(è¡¨)ã€æ—…è¡Œè¨ˆç”»" ]
      },
      {
        "sentence": "We heard a ___ noise coming from the basement.",
        "answers": [ "faint" ],
        "translation": "We heard a faint noise coming from the basement.",
        "jpTranslation": "åœ°ä¸‹å®¤ã‹ã‚‰ã‹ã™ã‹ãªç‰©éŸ³ãŒèã“ãˆãŸã€‚",
        "blanksTranslation": [ "ã‹ã™ã‹ãª" ]
      },
      {
        "sentence": "She left ___ instructions regarding how to take care of her dogs.",
        "answers": [ "explicit" ],
        "translation": "She left explicit instructions regarding how to take care of her dogs.",
        "jpTranslation": "å½¼å¥³ã¯çŠ¬ãŸã¡ã®ä¸–è©±ã®ä»•æ–¹ã«ã¤ã„ã¦æ˜ç¢ºãªæŒ‡ç¤ºã‚’æ®‹ã—ãŸã€‚",
        "blanksTranslation": [ "æ˜ç™½ãªã€ã‚ã‹ã‚‰ã•ã¾ãª" ]
      },
      {
        "sentence": "His grandmother was always ___ when he was a child.",
        "answers": [ "lenient" ],
        "translation": "His grandmother was always lenient when he was a child.",
        "jpTranslation": "å½¼ãŒå­ã©ã‚‚ã®ã“ã‚ã€å½¼ã®ç¥–æ¯ã¯ã„ã¤ã‚‚ç”˜ã‹ã£ãŸã€‚",
        "blanksTranslation": [ "å¯›å¤§ãªã€ç”˜ã„" ]
      },
      {
        "sentence": "Have you ever ___ quitting and finding a new job?",
        "answers": [ "contemplated" ],
        "translation": "Have you ever contemplated quitting and finding a new job?",
        "jpTranslation": "ä»•äº‹ã‚’è¾ã‚ã¦æ–°ã—ã„ä»•äº‹ã‚’æ¢ã™ã“ã¨ã‚’è€ƒãˆãŸã“ã¨ã¯ã‚ã‚Šã¾ã™ã‹ã€‚",
        "blanksTranslation": [ "ã€œã‚’ç†Ÿè€ƒã™ã‚‹" ]
      },
      {
        "sentence": "You shall be ___ innocent unless you are proven guilty.",
        "answers": [ "presumed" ],
        "translation": "You shall be presumed innocent unless you are proven guilty.",
        "jpTranslation": "æœ‰ç½ªã¨è¨¼æ˜ã•ã‚Œãªã„é™ã‚Šã€ã‚ãªãŸã¯ç„¡ç½ªã¨è¦‹ãªã•ã‚Œã¾ã™ã€‚",
        "blanksTranslation": [ "ã€œã¨æ¨å®šã™ã‚‹ã€è¦‹ãªã™" ]
      },
      {
        "sentence": "___ bags cannot be used as carry-on luggage.",
        "answers": [ "Bulky" ],
        "translation": "Bulky bags cannot be used as carry-on luggage.",
        "jpTranslation": "ã‹ã•ã°ã‚‹ãƒãƒƒã‚°ã¯æ©Ÿå†…æŒã¡è¾¼ã¿æ‰‹è·ç‰©ã¨ã—ã¦ã¯ä½¿ç”¨ã§ããªã„ã€‚",
        "blanksTranslation": [ "ã‹ã•ã°ã£ãŸã€å¤§ããã¦æ‰±ã„ã«ãã„" ]
      },
      {
        "sentence": "The candidate ___ the election following the court's decision.",
        "answers": [ "conceded" ],
        "translation": "The candidate conceded the election following the court's decision.",
        "jpTranslation": "ãã®å€™è£œè€…ã¯ã€è£åˆ¤æ‰€ã®æ±ºå®šã«å¾“ã£ã¦é¸æŒ™ã®æ•—åŒ—ã‚’èªã‚ãŸã€‚",
        "blanksTranslation": [ "(æ•—åŒ—)ã‚’èªã‚ã‚‹" ]
      },
      {
        "sentence": "She ___ her shoulders when her teacher asked her the question.",
        "answers": [ "shrugged" ],
        "translation": "She shrugged her shoulders when her teacher asked her the question.",
        "jpTranslation": "å…ˆç”Ÿã«è³ªå•ã•ã‚Œã¦ã€å½¼å¥³ã¯è‚©ã‚’ã™ãã‚ãŸã€‚",
        "blanksTranslation": [ "(è‚©)ã‚’ã™ãã‚ã‚‹" ]
      },
      {
        "sentence": "Investigators worked to ___ the crime scene.",
        "answers": [ "reconstruct" ],
        "translation": "Investigators worked to reconstruct the crime scene.",
        "jpTranslation": "æœæŸ»å®˜ãŸã¡ã¯çŠ¯è¡Œç¾å ´ã‚’å†ç¾ã—ã‚ˆã†ã¨å–ã‚Šçµ„ã‚“ã ã€‚",
        "blanksTranslation": [ "ã€œã‚’å†ç¾ã™ã‚‹" ]
      },
      {
        "sentence": "There were many large ___ surrounding the demolition site.",
        "answers": [ "barricades" ],
        "translation": "There were many large barricades surrounding the demolition site.",
        "jpTranslation": "è§£ä½“ç¾å ´ã‚’å–ã‚Šå›²ã‚€å¤§ããªãƒãƒªã‚±ãƒ¼ãƒ‰ãŒãŸãã•ã‚“ã‚ã£ãŸã€‚",
        "blanksTranslation": [ "ãƒãƒªã‚±ãƒ¼ãƒ‰ã€éšœå®³ç‰©" ]
      },
      {
        "sentence": "The couple went to an ___ dinner with the CEO.",
        "answers": [ "extravagant" ],
        "translation": "The couple went to an extravagant dinner with the CEO.",
        "jpTranslation": "ãã®å¤«å©¦ã¯CEOã¨è±ªè¯ãªãƒ‡ã‚£ãƒŠãƒ¼ã«è¡Œã£ãŸã€‚",
        "blanksTranslation": [ "æµªè²»ã™ã‚‹ã€ãœã„ãŸããª" ]
      },
      {
        "sentence": "The business partners worked hard to ___ their differences.",
        "answers": [ "reconcile" ],
        "translation": "The business partners worked hard to reconcile their differences.",
        "jpTranslation": "ãƒ“ã‚¸ãƒã‚¹ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ãŸã¡ã¯ç›¸é•ç‚¹ã‚’èª¿æ•´ã™ã‚‹ãŸã‚ã«åŠªåŠ›ã—ãŸã€‚",
        "blanksTranslation": [ "ã€œã‚’èª¿å’Œã•ã›ã‚‹ã€èª¿æ•´ã™ã‚‹" ]
      },
      {
        "sentence": "Monthly members are ___ from paying the admission fee.",
        "answers": [ "exempt" ],
        "translation": "Monthly members are exempt from paying the admission fee.",
        "jpTranslation": "æœˆä¼šå“¡ã¯å…¥å ´æ–™ã‚’å…é™¤ã•ã‚Œã¾ã™ã€‚",
        "blanksTranslation": [ "å…é™¤ã•ã‚ŒãŸ" ]
      },
      {
        "sentence": "She takes a ___ around the park every morning.",
        "answers": [ "stroll" ],
        "translation": "She takes a stroll around the park every morning.",
        "jpTranslation": "å½¼å¥³ã¯æ¯æœå…¬åœ’ã‚’ã®ã‚“ã³ã‚Šæ•£æ­©ã™ã‚‹ã€‚",
        "blanksTranslation": [ "æ•£ç­–ã€ããã‚æ­©ã" ]
      },
      {
        "sentence": "They are ___ for being inflexible in their opinions.",
        "answers": [ "notorious" ],
        "translation": "They are notorious for being inflexible in their opinions.",
        "jpTranslation": "å½¼ã‚‰ã¯è‡ªåˆ†ã®æ„è¦‹ã‚’æ›²ã’ãªã„ã“ã¨ã§æ‚ªåé«˜ã„ã€‚",
        "blanksTranslation": [ "æ‚ªåé«˜ã„ã€ã‚ˆãçŸ¥ã‚‰ã‚ŒãŸ" ]
      },
      {
        "sentence": "We could ___ the quality of sound produced by our headphones.",
        "answers": [ "enhance" ],
        "translation": "We could enhance the quality of sound produced by our headphones.",
        "jpTranslation": "ç§ãŸã¡ã¯ã€ãƒ˜ãƒƒãƒ‰ãƒ•ã‚©ãƒ³ã‹ã‚‰å‡ºã‚‹éŸ³ã®è³ªã‚’é«˜ã‚ã‚‹ã“ã¨ãŒã§ããŸã€‚",
        "blanksTranslation": [ "ã€œã‚’é«˜ã‚ã‚‹ã€å‘ä¸Šã•ã›ã‚‹" ]
      },
      {
        "sentence": "This mark ___ that the food was grown organically.",
        "answers": [ "signifies" ],
        "translation": "This mark signifies that the food was grown organically.",
        "jpTranslation": "ã“ã®ãƒãƒ¼ã‚¯ã¯é£Ÿå“ãŒæœ‰æ©Ÿè¾²æ³•ã§ç”Ÿç”£ã•ã‚ŒãŸã“ã¨ã‚’ç¤ºã—ã¦ã„ã‚‹ã€‚",
        "blanksTranslation": [ "ã€œã‚’ç¤ºã™ã€çŸ¥ã‚‰ã›ã‚‹" ]
      }
    ]
    // â–²â–²â–² å¤‰æ›´ç‚¹ â–²â–²â–²
    
    const CORRECT_PASSWORD = '1234';

    let playerName = '';
    let questions = [];
    let current = 0, score = 0;
    let lastAnsweredIndex = -1;
    let userAnswers = [], incorrectQuestions = [], retryMode = false, wrongAnswers = [];
    let keyupLock = false;
    
    const header = document.querySelector("header");
    const startScreen = document.getElementById("start-screen");
    const startBtn = document.getElementById("startBtn");
    const usernameInput = document.getElementById("username");
    const quizContainer = document.querySelector(".quiz-container");
    const qEl = document.getElementById("question");
    const inputEl = document.getElementById("inputs");
    const feedbackEl = document.getElementById("feedback");
    const translationEl = document.getElementById("translation");
    const scoreBoard = document.getElementById("scoreBoard");
    const pdfBtn = document.getElementById("pdfBtn");
    const wrongPdfBtn = document.getElementById("wrongPdfBtn");
    const retryBtn = document.getElementById("retryBtn");
    const showAllBtn = document.getElementById("showAllBtn");
    const submitBtn = document.getElementById("submitBtn");
    const nextBtn = document.getElementById("nextBtn");
    const progressBar = document.getElementById("progressBar");
    const progressEl = document.getElementById("progress");
    const downloadAllBtn = document.getElementById("downloadAllBtn");
    const backToStartBtn = document.getElementById("backToStartBtn");
    const prevBtn = document.getElementById("prevBtn");
    const toggleHistoryBtn = document.getElementById("toggleHistoryBtn");
    const historyContainer = document.getElementById("history-container");
    const clearHistoryBtn = document.getElementById("clearHistoryBtn");
    const historySearchInput = document.getElementById("historySearchInput");
    
    function loadQuestion() {
      retryBtn.classList.add("hidden"); 
      prevBtn.classList.add("hidden");
      nextBtn.classList.add("hidden");
      showAllBtn.classList.add("hidden");
      qEl.style.marginBottom = "";
      translationEl.style.marginTop = "";
      const q = questions[current];
      qEl.innerHTML = `<div>Q${current + 1} / ${questions.length}: ${q.sentence}</div><div class="jp-translation">${q.jpTranslation}</div>`;
      inputEl.innerHTML = "";
      feedbackEl.textContent = "";
      translationEl.textContent = "";
      q.answers.forEach((_, i) => {
        const inp = document.createElement("input");
        inp.type = "text";
        inp.className = "input-field";
        inp.id = "ans" + i;
        inputEl.appendChild(inp);
      });
      const inputs = document.querySelectorAll(".input-field");
      inputs[0].focus();
      inputs.forEach((inp, idx) => {
        inp.addEventListener("keydown", e => {
          if (e.key === "Enter") { 
            e.preventDefault(); 
            if (idx < inputs.length - 1) {
                inputs[idx + 1].focus();
            } else {
                keyupLock = true;
                checkAnswer();
            }
          }
        });
      });
      if (userAnswers[current]) {
          inputs.forEach((inp, i) => {
              inp.value = userAnswers[current].user[i] || "";
          });
      }
      submitBtn.classList.remove("hidden");
      const progressPercentage = (questions.length > 1) ? Math.round((current / (questions.length - 1)) * 100) : 0;
      progressEl.style.width = `${progressPercentage}%`;
    }
    function recalculateScore() {
        let newScore = 0;
        userAnswers.forEach((answer, index) => {
            if (answer && questions[index]) {
                const correctAnswers = questions[index].answers;
                const isCorrect = answer.user.every((userAns, i) => (userAns || "").toLowerCase() === (correctAnswers[i] || "").toLowerCase());
                if (isCorrect) {
                    newScore++;
                }
            }
        });
        score = newScore;
    }
    function checkAnswer() {
      const q = questions[current];
      let correct = true, answersGiven = [];
      q.answers.forEach((ans, i) => {
        const userAns = document.getElementById("ans" + i).value.trim();
        answersGiven.push(userAns);
        if (userAns.toLowerCase() !== ans.toLowerCase()) correct = false;
      });
      userAnswers[current] = { question: q.sentence, user: answersGiven, correct: q.answers };
      if (!retryMode) {
          recalculateScore();
      }
      if (!correct) {
        if (!incorrectQuestions.some(item => item.sentence === q.sentence)) incorrectQuestions.push(q);
        if (!wrongAnswers.some(item => item.sentence === q.sentence)) wrongAnswers.push(q);
      } else {
        incorrectQuestions = incorrectQuestions.filter(item => item.sentence !== q.sentence);
        wrongAnswers = wrongAnswers.filter(item => item.sentence !== q.sentence);
      }
      lastAnsweredIndex = Math.max(lastAnsweredIndex, current);
      displayAnsweredQuestion(current);
    }
    function loadNextNewQuestion() {
      current++;
      loadQuestion();
    }
    function displayAnsweredQuestion(index) {
        current = index;
        const q = questions[index];
        const recordedEntry = userAnswers[index];
        qEl.innerHTML = `<div>Q${index + 1} / ${questions.length}: ${q.sentence}</div><div class="jp-translation">${q.jpTranslation}</div>`;
        inputEl.innerHTML = "";
        q.answers.forEach((_, i) => {
            const inp = document.createElement("input");
            inp.type = "text";
            inp.className = "input-field";
            inp.id = "ans" + i;
            inputEl.appendChild(inp);
        });
        const inputs = inputEl.querySelectorAll(".input-field");
        inputs.forEach((inp, i) => {
            inp.value = recordedEntry.user[i] || "";
            inp.disabled = true;
            const userAnswerText = recordedEntry.user[i] || "";
            const correctAnswerText = q.answers[i] || "";
            const wasThisPartCorrect = userAnswerText.toLowerCase() === correctAnswerText.toLowerCase();
            inp.style.borderColor = wasThisPartCorrect ? '#28a745' : '#dc3545';
            inp.style.borderWidth = '2px';
        });
        submitBtn.classList.add("hidden");
        const userWasCorrect = recordedEntry.user.join(",").toLowerCase() === recordedEntry.correct.join(",").toLowerCase();
        feedbackEl.className = "";
        if (userWasCorrect) {
            feedbackEl.textContent = "âœ… Correct!";
            feedbackEl.classList.add("correct");
        } else {
            feedbackEl.textContent = "âŒ Incorrect!";
            feedbackEl.classList.add("incorrect");
        }
        let highlighted = q.translation;
        q.answers.forEach(ans => {
            const regex = new RegExp(`\\b${ans}\\b`, "gi");
            highlighted = highlighted.replace(regex, `<span style="color:red; font-weight:bold;">${ans}</span>`);
        });
        translationEl.innerHTML = `
            <p><b>è‹±æ–‡:</b> ${highlighted} <button class="circle-button" onclick="speak('${q.translation}')">ğŸ”Š</button></p>
            <p><b>ç­”ãˆ:</b> ${q.answers.join(", ")} ${q.answers.map(ans => `<button class="circle-button" onclick="speak('${ans}')">ğŸ”Š</button>`).join(" ")}</p>
            <p><b>å’Œè¨³:</b> ${q.jpTranslation}</p>
            <p><b>ç­”ãˆã®å’Œè¨³:</b> ${q.blanksTranslation.join(", ")}</p>
        `;
        const isLastQuestion = index === questions.length - 1;
        prevBtn.classList.toggle("hidden", index <= 0);
        showAllBtn.classList.toggle("hidden", !isLastQuestion);
        nextBtn.classList.toggle("hidden", isLastQuestion);
    }
    function goToPreviousQuestion() {
        if (current > 0) {
            current--;
            loadQuestion();
        }
    }
    function handleNextClick() {
        if (current < lastAnsweredIndex) {
            displayAnsweredQuestion(current + 1);
        } else {
            loadNextNewQuestion();
        }
    }
    
    function showAllResults() {
        progressBar.classList.add("hidden");
        const finalScoreText = retryMode ? `${score} / ${questions.length}` : `${score} / ${allQuestions.length}`;
        const username = playerName || "(No name)";

        savePlayHistory(username, finalScoreText);
        displayPlayHistory();
        scoreBoard.textContent = `Your score: ${finalScoreText}`;
        
        qEl.textContent = "All Results";
        inputEl.innerHTML = "";
        feedbackEl.textContent = "";
        translationEl.innerHTML = "";
        qEl.style.marginBottom = "0";
        translationEl.style.marginTop = "5px";
        translationEl.innerHTML = `<p style="margin: 0;"><b>Name:</b> ${username}</p><p><b>Score:</b> ${finalScoreText}</p>`;
        
        userAnswers.forEach((entry, idx) => {
            if (!entry) return;
            const originalQuestion = allQuestions.find(q => q.sentence === entry.question);
            if (!originalQuestion) return;
            let highlightedSentence = originalQuestion.translation;
            originalQuestion.answers.forEach(ans => {
                const regex = new RegExp(`\\b(${ans})\\b`, 'gi');
                highlightedSentence = highlightedSentence.replace(regex, `<span style="color: red; font-weight: bold;">$1</span>`);
            });
            const userAnswersGiven = entry.user.join(", ");
            const isAnswerCorrect = userAnswersGiven.toLowerCase() === entry.correct.join(", ").toLowerCase();
            let yourAnswerHTML = isAnswerCorrect ? `<p style="margin: 5px 0;"><b>Your Answer:</b> ${userAnswersGiven} <span style="color: #28a745;">âœ…</span></p>` : `<p style="margin: 5px 0;"><b>Your Answer:</b> <span style="color: #dc3545;">${userAnswersGiven || "(no answer)"}</span> âŒ</p>`;
            const div = document.createElement("div");
            div.style.cssText = "text-align: left; margin: 15px 10px; border-bottom: 1px solid #eee; padding-bottom: 10px;";
            div.innerHTML = `<p style="margin: 5px 0;"><b>Q${idx + 1}:</b> ${highlightedSentence}</p><p style="margin: 5px 0; color: #555; font-size: 14px;"><b>å’Œè¨³:</b> ${originalQuestion.jpTranslation}</p>${yourAnswerHTML}`;
            translationEl.appendChild(div);
        });

        pdfBtn.classList.remove("hidden");
        backToStartBtn.classList.remove("hidden");
        if (wrongAnswers.length > 0) wrongPdfBtn.classList.remove("hidden");
        if (incorrectQuestions.length > 0) {
            retryBtn.textContent = `é–“é•ãˆãŸ ${incorrectQuestions.length} å•ã«å†æŒ‘æˆ¦`;
            retryBtn.classList.remove("hidden");
        } else {
            retryBtn.classList.add("hidden");
        }
        showAllBtn.classList.add("hidden"); nextBtn.classList.add("hidden"); prevBtn.classList.add("hidden");
    }

    function savePlayHistory(name, scoreText) {
      const date = new Date();
      const formattedDate = `${date.getFullYear()}/${date.getMonth() + 1}/${date.getDate()} ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
      const newRecord = { 
        name: name, 
        score: scoreText, 
        date: formattedDate,
        results: JSON.parse(JSON.stringify(userAnswers))
      };
      const history = JSON.parse(localStorage.getItem('quizPlayHistory')) || [];
      history.unshift(newRecord);
      localStorage.setItem('quizPlayHistory', JSON.stringify(history));
    }

    function displayPlayHistory(searchTerm = '') {
      let history = JSON.parse(localStorage.getItem('quizPlayHistory')) || [];
      const historyList = document.getElementById('history-list');
      const lowerCaseSearchTerm = searchTerm.toLowerCase();

      if (lowerCaseSearchTerm) {
        history = history.filter(record => {
          const recordText = `[${record.date}] ${record.name} - ã‚¹ã‚³ã‚¢: ${record.score}`.toLowerCase();
          return recordText.includes(lowerCaseSearchTerm);
        });
      }

      historyList.innerHTML = '';
      
      history.forEach(record => {
        const listItem = document.createElement('li');
        listItem.textContent = `[${record.date}] ${record.name} - ã‚¹ã‚³ã‚¢: ${record.score}`;
        listItem.title = 'ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã“ã®çµæœã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰';
        listItem.addEventListener('click', () => {
          downloadHistoryPDF(record);
        });
        historyList.appendChild(listItem);
      });
    }
    
    function initQuiz() { 
        lastAnsweredIndex = -1; 
        score = 0; 
        userAnswers = []; 
        incorrectQuestions = []; 
        wrongAnswers = []; 
        questions = [...allQuestions]; 
        loadProgress(); 
        shuffle(questions); 
        current = 0; 
        loadQuestion(); 
    }
    function restartQuiz() { 
        window.location.reload();
    }
    function retryIncorrect() { 
        if (incorrectQuestions.length === 0) return; 
        lastAnsweredIndex = -1; 
        score = 0; 
        userAnswers = []; 
        wrongAnswers = []; 
        questions = [...incorrectQuestions]; 
        incorrectQuestions = []; 
        retryMode = true; 
        scoreBoard.textContent = ""; 
        progressBar.classList.remove("hidden"); 
        pdfBtn.classList.add("hidden"); 
        wrongPdfBtn.classList.add("hidden"); 
        retryBtn.classList.add("hidden"); 
        backToStartBtn.classList.add("hidden"); 
        quizContainer.classList.remove("hidden");
        header.classList.remove("hidden");
        current = 0; 
        loadQuestion(); 
    }
    function shuffle(array) { 
        for (let i = array.length - 1; i > 0; i--) { 
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]]; 
        } 
    }
    function saveProgress() { 
        const incorrectSentences = incorrectQuestions.map(q => q.sentence); 
        localStorage.setItem('eikenQuizIncorrect', JSON.stringify(incorrectSentences)); 
    }
    function loadProgress() {
      try {
        const savedIncorrect = localStorage.getItem('eikenQuizIncorrect');
        if (savedIncorrect) {
          const incorrectSentences = JSON.parse(savedIncorrect);
          if (Array.isArray(incorrectSentences)) {
            const loadedIncorrect = allQuestions.filter(q => incorrectSentences.includes(q.sentence));
            if (loadedIncorrect.length > 0) {
              incorrectQuestions = loadedIncorrect;
              retryBtn.textContent = `é–“é•ãˆãŸ ${incorrectQuestions.length} å•ã«å†æŒ‘æˆ¦`;
              retryBtn.classList.remove("hidden");
            }
          }
        }
      } catch (e) {
        console.error("ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:", e);
        localStorage.removeItem('eikenQuizIncorrect');
      }
    }
    function speak(text) { 
        const u = new SpeechSynthesisUtterance(text); 
        u.lang = "en-US"; 
        u.voice = speechSynthesis.getVoices().find(v => v.lang === "en-US" && v.name.includes("Female")) || null; 
        speechSynthesis.speak(u); 
    }
    function downloadPDF() { 
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const username = playerName;
        const finalScoreText = retryMode ? `${score} / ${questions.length}` : `${score} / ${allQuestions.length}`;
        doc.setFontSize(14);
        doc.text("Quiz Results", 10, 10);
        if (username) doc.text(`Name: ${username}`, 10, 20);
        doc.text(`Score: ${finalScoreText}`, 10, 30);
        let y = 40;
        userAnswers.forEach((entry, idx) => {
            if (!entry) return;
            const linesQ = doc.splitTextToSize(`Q${idx + 1}: ${entry.question}`, 180);
            doc.text(linesQ, 10, y); y += linesQ.length * 7;
            const linesU = doc.splitTextToSize(`Your Answer: ${entry.user.join(", ")}`, 180);
            doc.text(linesU, 10, y); y += linesU.length * 7;
            const linesC = doc.splitTextToSize(`Correct Answer: ${entry.correct.join(", ")}`, 180);
            doc.text(linesC, 10, y); y += linesC.length * 7 + 5;
            if (y > 270) { doc.addPage(); y = 20; }
        });
        doc.save("quiz_results.pdf");
    }
    function downloadWrongPDF() { 
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.setFontSize(14);
        doc.text("Wrong Vocabulary Results", 10, 10);
        let y = 20;
        wrongAnswers.forEach((q, idx) => {
            const linesQ = doc.splitTextToSize(`${idx + 1}. ${q.sentence}`, 180);
            doc.text(linesQ, 10, y); y += linesQ.length * 8;
            const linesA = doc.splitTextToSize(`Answer: ${q.answers.join(", ")}`, 180);
            doc.text(linesA, 10, y); y += linesA.length * 8 + 5;
            if (y > 270) { doc.addPage(); y = 20; }
        });
        doc.save("Wrong-vocab.pdf");
    }
    function downloadHistoryPDF(historyRecord) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFontSize(16);
      doc.text("Quiz Results", 105, 15, null, null, "center");
      doc.setFontSize(12);
      doc.text(`Name: ${historyRecord.name}`, 10, 25);
      doc.text(`Score: ${historyRecord.score}`, 10, 32);
      doc.text(`Date: ${historyRecord.date}`, 10, 39);
      let y = 50; 
      historyRecord.results.forEach((entry, idx) => {
        if (!entry) return;
        if (y > 270) {
          doc.addPage();
          y = 20;
        }
        const isCorrect = entry.user.join(",").toLowerCase() === entry.correct.join(",").toLowerCase();
        doc.setFontSize(12);
        doc.text(`Q${idx + 1}: ${entry.question}`, 10, y);
        y += 7;
        doc.setFontSize(10);
        doc.setTextColor(isCorrect ? '#28a745' : '#dc3545'); 
        doc.text(`Your Answer: ${entry.user.join(", ") || "(no answer)"}`, 15, y);
        y += 7;
        if (!isCorrect) {
          doc.setTextColor('#333333'); 
          doc.text(`Correct Answer: ${entry.correct.join(", ")}`, 15, y);
          y += 7;
        }
        y += 5; 
      });
      const fileName = `quiz-results-${historyRecord.date.replace(/[/:\s]/g, '-')}.pdf`;
      doc.save(fileName);
    }
    function downloadAllQuestionsPDF() { 
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.setFontSize(16);
        doc.text("Eiken Pre-1 Vocabulary List", 10, 15);
        let y = 25;
        doc.setFontSize(12);
        allQuestions.forEach((q, idx) => {
            if (y > 270) { doc.addPage(); y = 20; }
            const questionText = `${idx + 1}. ${q.sentence.replace('___', `[ ${q.answers[0]} ]`)}`;
            const linesQ = doc.splitTextToSize(questionText, 180);
            doc.text(linesQ, 10, y);
            y += linesQ.length * 7 + 5;
        });
        doc.save("Eiken-Pre-1-Vocab-List.pdf");
    }

    // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---
    pdfBtn.onclick = downloadPDF;
    wrongPdfBtn.onclick = downloadWrongPDF;
    submitBtn.onclick = checkAnswer;
    nextBtn.onclick = handleNextClick;
    prevBtn.onclick = goToPreviousQuestion;
    showAllBtn.onclick = showAllResults;
    retryBtn.onclick = retryIncorrect;
    downloadAllBtn.onclick = downloadAllQuestionsPDF;
    backToStartBtn.onclick = restartQuiz;

    toggleHistoryBtn.addEventListener('click', () => {
      if (historyContainer.classList.contains('show')) {
        historyContainer.classList.remove('show');
        toggleHistoryBtn.textContent = 'å±¥æ­´ã‚’è¦‹ã‚‹';
      } 
      else {
        const inputPassword = prompt('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
        if (inputPassword === null) return;

        if (inputPassword === CORRECT_PASSWORD) {
          historyContainer.classList.add('show');
          toggleHistoryBtn.textContent = 'å±¥æ­´ã‚’é–‰ã˜ã‚‹';
        } else {
          alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™ã€‚');
        }
      }
    });

    clearHistoryBtn.addEventListener('click', () => {
      const inputPassword = prompt('å±¥æ­´ã‚’å‰Šé™¤ã™ã‚‹ã«ã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
      if (inputPassword === null) {
        return;
      }
      if (inputPassword === CORRECT_PASSWORD) {
        if (confirm('æœ¬å½“ã«ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿã™ã¹ã¦ã®å±¥æ­´ãŒå®Œå…¨ã«å‰Šé™¤ã•ã‚Œã¾ã™ã€‚')) {
          localStorage.removeItem('quizPlayHistory');
          historySearchInput.value = '';
          displayPlayHistory();
          alert('å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚');
        }
      } else {
        alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™ã€‚');
      }
    });

    document.addEventListener('keyup', (event) => {
        if (event.key !== 'Enter') return;
        if (keyupLock) {
            keyupLock = false;
            return;
        }
        if (document.activeElement && document.activeElement.tagName === 'INPUT') {
            return;
        }
        if (!nextBtn.classList.contains('hidden')) {
            handleNextClick();
        } 
        else if (!showAllBtn.classList.contains('hidden')) {
            showAllResults();
        }
    });

    document.addEventListener('DOMContentLoaded', () => {
      displayPlayHistory();
    });

    startBtn.addEventListener('click', () => {
      const name = usernameInput.value.trim();
      if (name === '') {
        alert('Please enter your name.');
        return;
      }
      
      playerName = name;
      
      startScreen.classList.add('hidden');
      quizContainer.classList.remove('hidden');
      header.classList.remove('hidden');
      
      initQuiz();
    });

    usernameInput.addEventListener('keydown', (event) => {
      if (event.key === 'Enter') {
        event.preventDefault();
        startBtn.click();
      }
    });
    
    historySearchInput.addEventListener('input', () => {
      displayPlayHistory(historySearchInput.value);
    });
  </script>
</body>
</html>
