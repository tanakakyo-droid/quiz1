<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>B1 Vocabulary Quiz Template</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; text-align: center; }
    .quiz-container { max-width: 700px; margin: auto; }
    .question { margin-bottom: 20px; font-size: 18px; }
    .choices { margin-top: 15px; display: flex; flex-direction: column; align-items: center; }
    .choices button { margin: 5px; padding: 10px 16px; border-radius: 6px; cursor: pointer; min-width: 150px; text-align: center; }
    .progress { width: 100%; background: #ddd; height: 20px; border-radius: 10px; margin: 20px 0; }
    .bar { height: 100%; width: 0; background: #4caf50; border-radius: 10px; }
    .hidden { display: none; }
    .nav-buttons { margin-top: 20px; display: flex; justify-content: center; gap: 15px; }
    .nav-buttons button { padding: 8px 14px; border-radius: 6px; cursor: pointer; }
  </style>
</head>
<body>
  <div class="quiz-container">
    <h1>B1 Vocabulary Quiz</h1>
    <label>名前: <input type="text" id="username" placeholder="Your name"></label>

    <div class="progress"><div id="progress-bar" class="bar"></div></div>
    <div id="quiz"></div>
    <div id="result" class="hidden"></div>
    <button id="finishBtn" onclick="finishQuiz()" class="hidden">📄 Save as PDF</button>
  </div>

  <script>
    let WORDS = [
      { w:"apple", jp:"りんご", s:"I ate an ______ yesterday.", t:"私は昨日りんごを食べました。" },
      { w:"dog", jp:"犬", s:"The ______ is barking.", t:"犬が吠えています。" },
      { w:"car", jp:"車", s:"That ______ is very fast.", t:"あの車はとても速いです。" },
      { w:"book", jp:"本", s:"I am reading a ______.", t:"私は本を読んでいます。" },
      { w:"house", jp:"家", s:"This ______ is big.", t:"この家は大きいです。" }
    ];

    // 50問に拡張（足りない分はダミーで補充）
    while (WORDS.length < 50) {
      WORDS.push({ w:`word${WORDS.length+1}`, jp:"訳", s:`This is question ______ number ${WORDS.length+1}.`, t:"これはダミー問題です。" });
    }

    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    WORDS = shuffle(WORDS);

    let currentIndex = 0;
    let answers = [];
    let username = "";

    function speak(text) {
      const utter = new SpeechSynthesisUtterance(text);
      utter.lang = 'en-US';
      speechSynthesis.speak(utter);
    }

    function loadQuestion() {
      if (currentIndex >= WORDS.length) {
        showResult();
        return;
      }
      username = document.getElementById("username").value.trim();
      const q = WORDS[currentIndex];

      let otherWords = WORDS.filter((w, idx) => idx !== currentIndex).map(w => w.w);
      otherWords = shuffle(otherWords).slice(0, 3);
      let options = shuffle([q.w, ...otherWords]);

      const quizDiv = document.getElementById("quiz");
      quizDiv.innerHTML = `
        <div class="question">
          <p>Q${currentIndex+1}: ${q.s}
          <button onclick="speak('${q.s.replace("______","...")}')">🔊</button></p>
          <div class="choices">
            ${options.map(opt =>
              `<div><button onclick=\"selectAnswer('${opt}')\">${opt}</button>
               <button onclick=\"speak('${opt}')\">🔊</button></div>`
            ).join("")}
          </div>
          <div class="nav-buttons">
            <button onclick="goBack()" ${currentIndex===0?"disabled":""}>⬅ 戻る</button>
            <button onclick="skipQuestion()">➡ スキップ</button>
          </div>
        </div>
      `;
      updateProgress();
    }

    function selectAnswer(choice) {
      answers[currentIndex] = choice;
      currentIndex++;
      loadQuestion();
    }

    function skipQuestion() {
      if (!answers[currentIndex]) {
        answers[currentIndex] = "未回答";
      }
      currentIndex++;
      loadQuestion();
    }

    function goBack() {
      if (currentIndex > 0) {
        currentIndex--;
        loadQuestion();
      }
    }

    function updateProgress() {
      const bar = document.getElementById("progress-bar");
      bar.style.width = ((currentIndex/WORDS.length)*100) + "%";
    }

    function showResult() {
      document.getElementById("quiz").innerHTML = "";
      let score = 0;
      let resultHtml = `<h2>Result</h2><p><b>Name:</b> ${username || "(未入力)"}</p><ol>`;
      WORDS.forEach((q,i) => {
        const ans = answers[i] || "未回答";
        const correct = q.w;
        const isCorrect = ans === correct;
        if (isCorrect) score++;
        resultHtml += `<li style="text-align:left;">
          <b>英文:</b> ${q.s}<br>
          <b>Your answer:</b> ${ans} ${isCorrect ? "✅" : "❌"}<br>
          <b>Correct:</b> ${correct} (${q.jp})
        </li><br>`;
      });
      resultHtml += `</ol><h3>Score: ${score} / ${WORDS.length}</h3>`;
      const resDiv = document.getElementById("result");
      resDiv.innerHTML = resultHtml;
      resDiv.classList.remove("hidden");
      document.getElementById("finishBtn").classList.remove("hidden");
    }

    async function finishQuiz() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({unit: "mm", format: "a4"});

      username = document.getElementById("username").value.trim();

      let y = 10;
      doc.setFontSize(14);
      doc.text("B1 Vocabulary Quiz Result", 10, y);
      if (username) {
        doc.text(`Name: ${username}`, 200, y, { align: "right" });
      }
      y += 10;

      let score = 0;
      WORDS.forEach((q,i) => {
        const ans = answers[i] || "未回答";
        const correct = q.w;
        if (ans === correct) score++;
      });
      doc.text(`Score: ${score} / ${WORDS.length}`, 10, y); y+=10;

      doc.setFontSize(10);
      WORDS.forEach((q,i) => {
        const ans = answers[i] || "未回答";
        const correct = q.w;
        const text = `Q${i+1}: ${q.s}\nYour answer: ${ans}\nCorrect: ${correct}`;
        const split = doc.splitTextToSize(text, 180);
        doc.text(split, 10, y);
        y += split.length*5 + 5;
        if (y > 280) { doc.addPage(); y=10; }
      });

      const pdfBlob = doc.output("blob");
      const url = URL.createObjectURL(pdfBlob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "quiz_result.pdf";
      a.click();
      URL.revokeObjectURL(url);
    }

    loadQuestion();
  </script>
</body>
</html>
